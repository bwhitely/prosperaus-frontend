<div class="page-header">
  <div class="page-header__content">
    <h1>Equity Recycling Calculator</h1>
    <p class="subtitle">Model the tax benefits of recycling your home equity into income-producing investments</p>
    @if (getCurrentScenarioName(); as name) {
      <span class="scenario-badge">{{ name }}</span>
    }
  </div>
  <div class="page-header__actions">
    <button mat-stroked-button (click)="newScenario()">
      <mat-icon>add</mat-icon>
      New
    </button>
    <button mat-stroked-button (click)="openLoadForm()" [disabled]="scenarios().length === 0">
      <mat-icon>folder_open</mat-icon>
      Load ({{ scenarios().length }})
    </button>
    <button mat-flat-button color="primary" (click)="openSaveForm()" [disabled]="!result()">
      <mat-icon>save</mat-icon>
      {{ currentScenarioId() ? 'Update' : 'Save' }}
    </button>
  </div>
</div>

@if (error()) {
  <div class="alert alert--error">
    {{ error() }}
    <button mat-icon-button (click)="error.set(null)">
      <mat-icon>close</mat-icon>
    </button>
  </div>
}

<div class="calculator-layout">
  <!-- Input Form -->
  <div class="calculator-inputs">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Your Details</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="form">
          <!-- Property Details -->
          <div class="form-section">
            <h3>Property Details</h3>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Property Value</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="propertyValue" min="50000">
                @if (form.get('propertyValue')?.invalid && form.get('propertyValue')?.touched) {
                  <mat-error>Minimum $50,000</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Current Mortgage Balance</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="mortgageBalance" min="0">
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Interest Rate</mat-label>
                <input matInput type="number" formControlName="interestRate" step="0.1">
                <span matTextSuffix>%</span>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Offset Balance (Optional)</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="offsetBalance" min="0">
              </mat-form-field>
            </div>
          </div>

          <!-- Equity Info Box -->
          @if (result()) {
            <div class="equity-info-box">
              <mat-icon>account_balance</mat-icon>
              <div class="equity-info-content">
                <span class="equity-label">Available Equity (80% LVR)</span>
                <span class="equity-value">{{ result()!.availableEquity | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
              </div>
            </div>
          }

          <!-- Recycling Details -->
          <div class="form-section">
            <h3>Recycling Strategy</h3>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Amount to Recycle</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="amountToRecycle" min="1000">
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Expected Investment Return</mat-label>
                <input matInput type="number" formControlName="expectedReturn" step="0.5">
                <span matTextSuffix>% p.a.</span>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Marginal Tax Rate</mat-label>
                <mat-select formControlName="marginalTaxRate">
                  @for (bracket of taxBrackets; track bracket.rate) {
                    <mat-option [value]="bracket.rate">{{ bracket.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Projection Period</mat-label>
                <input matInput type="number" formControlName="projectionYears" min="1" max="30">
                <span matTextSuffix>years</span>
              </mat-form-field>
            </div>
          </div>

          <!-- Advanced Options -->
          <mat-expansion-panel class="advanced-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>Advanced Options</mat-panel-title>
              <mat-panel-description>Investment assumptions</mat-panel-description>
            </mat-expansion-panel-header>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Dividend Yield</mat-label>
                <input matInput type="number" formControlName="dividendYield" step="0.5">
                <span matTextSuffix>%</span>
                <mat-hint>Typical Australian shares: 3-5%</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Franking Rate</mat-label>
                <input matInput type="number" formControlName="frankingRate" min="0" max="100">
                <span matTextSuffix>%</span>
                <mat-hint>100% = fully franked dividends</mat-hint>
              </mat-form-field>
            </div>
          </mat-expansion-panel>

          <button
            mat-flat-button
            color="primary"
            class="calculate-btn"
            type="button"
            (click)="calculate()"
            [disabled]="form.invalid || isLoading()">
            @if (isLoading()) {
              <mat-spinner diameter="20"></mat-spinner>
              Calculating...
            } @else {
              <mat-icon>calculate</mat-icon>
              Calculate
            }
          </button>
        </form>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Results -->
  <div class="calculator-results">
    @if (isLoading() && !result()) {
      <mat-card class="loading-card">
        <mat-card-content>
          <mat-spinner diameter="40"></mat-spinner>
          <p>Calculating projections...</p>
        </mat-card-content>
      </mat-card>
    } @else if (result(); as r) {
      <!-- Summary Cards -->
      <div class="result-cards">
        <mat-card class="result-card result-card--primary">
          <mat-card-content>
            <span class="result-label">Total Benefit ({{ form.value.projectionYears }} years)</span>
            <span class="result-value" [class.positive]="r.totalBenefit > 0" [class.negative]="r.totalBenefit < 0">
              {{ r.totalBenefit | currency:'AUD':'symbol-narrow':'1.0-0' }}
            </span>
            <span class="result-change positive">{{ r.percentageBenefit | number:'1.1-1' }}% better than baseline</span>
          </mat-card-content>
        </mat-card>

        <mat-card class="result-card">
          <mat-card-content>
            <span class="result-label">Baseline (Do Nothing)</span>
            <span class="result-value">
              {{ r.baselineWealth | currency:'AUD':'symbol-narrow':'1.0-0' }}
            </span>
          </mat-card-content>
        </mat-card>

        <mat-card class="result-card result-card--highlight">
          <mat-card-content>
            <span class="result-label">With Recycling</span>
            <span class="result-value positive">
              {{ r.recyclingWealth | currency:'AUD':'symbol-narrow':'1.0-0' }}
            </span>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Annual Breakdown -->
      <mat-card class="breakdown-card">
        <mat-card-header>
          <mat-card-title>Annual Cost & Benefit</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="breakdown-grid">
            <div class="breakdown-item">
              <span class="breakdown-label">Interest Cost</span>
              <span class="breakdown-value negative">-{{ r.annualInterestCost | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
            </div>
            <div class="breakdown-item">
              <span class="breakdown-label">Tax Deduction</span>
              <span class="breakdown-value positive">+{{ r.annualTaxDeduction | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
            </div>
            <div class="breakdown-item">
              <span class="breakdown-label">Franking Credits</span>
              <span class="breakdown-value" [class.positive]="r.taxBenefits.frankingCredits > 0" [class.negative]="r.taxBenefits.frankingCredits < 0">
                {{ r.taxBenefits.frankingCredits >= 0 ? '+' : '' }}{{ r.taxBenefits.frankingCredits | currency:'AUD':'symbol-narrow':'1.0-0' }}
              </span>
            </div>
            <div class="breakdown-item breakdown-item--total">
              <span class="breakdown-label">Net Annual Cost</span>
              <span class="breakdown-value" [class.positive]="r.netAnnualCost < 0" [class.negative]="r.netAnnualCost > 0">
                {{ r.netAnnualCost | currency:'AUD':'symbol-narrow':'1.0-0' }}
              </span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Risk Assessment -->
      <mat-card class="risk-card">
        <mat-card-header>
          <mat-card-title>Risk Assessment</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="risk-assessment" [class]="getRiskClass(r.riskAssessment)">
            <mat-icon>
              @if (getRiskClass(r.riskAssessment) === 'risk-low') {
                check_circle
              } @else if (getRiskClass(r.riskAssessment) === 'risk-moderate') {
                info
              } @else {
                warning
              }
            </mat-icon>
            <p>{{ r.riskAssessment }}</p>
          </div>
          <div class="break-even-row">
            <span class="break-even-label">Break-even Return</span>
            <span class="break-even-value">{{ formatPercent(r.breakEvenReturn) }}</span>
          </div>
          <p class="break-even-note">
            Your investments need to return at least {{ formatPercent(r.breakEvenReturn) }} annually to cover the net interest cost.
          </p>
        </mat-card-content>
      </mat-card>

      <!-- Year-by-Year Projection -->
      <mat-card class="projection-card">
        <mat-card-header>
          <mat-card-title>Year-by-Year Projection</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="projection-chart">
            @for (projection of r.yearlyProjections; track projection.year) {
              <div class="projection-bar">
                <div class="projection-bar__header">
                  <span class="projection-bar__year">Year {{ projection.year }}</span>
                  <span class="projection-bar__value" [class.positive]="projection.netBenefit > 0" [class.negative]="projection.netBenefit < 0">
                    {{ projection.netBenefit | currency:'AUD':'symbol-narrow':'1.0-0' }}
                  </span>
                </div>
                <div class="projection-bar__track">
                  @if (projection.netBenefit > 0) {
                    <div
                      class="projection-bar__fill projection-bar__fill--positive"
                      [style.width.%]="(projection.netBenefit / r.totalBenefit) * 100">
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Disclaimer -->
      <div class="disclaimer">
        <mat-icon>info</mat-icon>
        <p>
          <strong>Important:</strong> This calculator provides estimates only and should not be considered financial advice.
          Interest deductibility depends on the borrowed funds being used for income-producing purposes.
          Consult a qualified financial adviser before implementing any equity recycling strategy.
        </p>
      </div>
    }
  </div>
</div>

<!-- Save Scenario Inline Form -->
@if (showSaveForm()) {
  <mat-card class="inline-form">
    <mat-card-header class="inline-form__header">
      <mat-card-title>{{ currentScenarioId() ? 'Update Scenario' : 'Save Scenario' }}</mat-card-title>
    </mat-card-header>
    <mat-card-content class="inline-form__body">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Scenario Name</mat-label>
        <input
          matInput
          type="text"
          [value]="scenarioName()"
          (input)="scenarioName.set($any($event.target).value)"
          placeholder="e.g., Primary residence - aggressive">
      </mat-form-field>
    </mat-card-content>
    <mat-card-actions align="end" class="inline-form__footer">
      <button mat-stroked-button (click)="closeSaveForm()">Cancel</button>
      <button
        mat-flat-button
        color="primary"
        (click)="saveScenario()"
        [disabled]="!scenarioName().trim() || isSaving()">
        @if (isSaving()) {
          <mat-spinner diameter="18"></mat-spinner>
        }
        {{ isSaving() ? 'Saving...' : (currentScenarioId() ? 'Update' : 'Save') }}
      </button>
    </mat-card-actions>
  </mat-card>
}

<!-- Load Scenario Inline Form -->
@if (showLoadForm()) {
  <mat-card class="inline-form">
    <mat-card-header class="inline-form__header">
      <mat-card-title>Load Scenario</mat-card-title>
    </mat-card-header>
    <mat-card-content class="inline-form__body">
      @if (scenarios().length === 0) {
        <p class="empty-message">No saved scenarios yet.</p>
      } @else {
        <div class="scenario-list">
          @for (scenario of scenarios(); track scenario.id) {
            <div
              class="scenario-item"
              [class.scenario-item--active]="scenario.id === currentScenarioId()"
              (click)="loadScenario(scenario)">
              <div class="scenario-item__info">
                <div class="scenario-item__name">{{ scenario.name }}</div>
                <div class="scenario-item__date">Last updated: {{ scenario.updatedAt | date:'medium' }}</div>
              </div>
              <button
                mat-icon-button
                color="warn"
                (click)="deleteScenario(scenario, $event)"
                matTooltip="Delete scenario">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          }
        </div>
      }
    </mat-card-content>
    <mat-card-actions align="end" class="inline-form__footer">
      <button mat-stroked-button (click)="closeLoadForm()">Cancel</button>
    </mat-card-actions>
  </mat-card>
}
