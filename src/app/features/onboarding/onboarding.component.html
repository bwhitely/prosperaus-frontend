<div class="onboarding">
  <mat-card class="onboarding__container">
    <div class="onboarding__header">
      <h1 class="onboarding__title">Welcome to ProsperAus</h1>
      <p class="onboarding__subtitle">Let's set up your profile to personalise your experience</p>
    </div>

    <!-- Progress indicator using Material Stepper styling -->
    <div class="onboarding__progress">
      @for (step of [1, 2, 3]; track step) {
        <div
          class="onboarding__progress-step"
          [class.onboarding__progress-step--active]="currentStep() >= step"
          [class.onboarding__progress-step--completed]="currentStep() > step"
        >
          <div class="onboarding__progress-circle">
            @if (currentStep() > step) {
              <mat-icon>check</mat-icon>
            } @else {
              {{ step }}
            }
          </div>
          <span class="onboarding__progress-label">
            @switch (step) {
              @case (1) { Basics }
              @case (2) { Tax Status }
              @case (3) { Preferences }
            }
          </span>
        </div>
        @if (step < 3) {
          <div
            class="onboarding__progress-line"
            [class.onboarding__progress-line--active]="currentStep() > step"
          ></div>
        }
      }
    </div>

    @if (error()) {
      <div class="alert alert--error">
        <mat-icon>error</mat-icon>
        <span>{{ error() }}</span>
      </div>
    }

    <form [formGroup]="onboardingForm" (ngSubmit)="onSubmit()">
      <!-- Step 1: Basic Info -->
      @if (currentStep() === 1) {
        <div class="onboarding__step">
          <h2 class="onboarding__step-title">Tell us about yourself</h2>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>What should we call you?</mat-label>
            <input matInput formControlName="displayName" placeholder="Enter your name">
            <mat-icon matPrefix>person</mat-icon>
            @if (onboardingForm.get('displayName')?.touched && onboardingForm.get('displayName')?.errors?.['required']) {
              <mat-error>Name is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Date of Birth</mat-label>
            <input matInput type="date" formControlName="dateOfBirth">
            <mat-icon matPrefix>cake</mat-icon>
            @if (onboardingForm.get('dateOfBirth')?.touched && onboardingForm.get('dateOfBirth')?.errors?.['required']) {
              <mat-error>Date of birth is required</mat-error>
            }
            <mat-hint>Used for super and retirement calculations</mat-hint>
          </mat-form-field>

          <div class="onboarding__actions">
            <button
              mat-flat-button
              color="primary"
              type="button"
              class="full-width"
              [disabled]="!canProceedFromStep1()"
              (click)="nextStep()"
            >
              Continue
            </button>
          </div>
        </div>
      }

      <!-- Step 2: Tax Status -->
      @if (currentStep() === 2) {
        <div class="onboarding__step">
          <h2 class="onboarding__step-title">Your tax situation</h2>

          <div class="form-section">
            <label class="form-section__label">Tax Residency Status</label>
            <mat-radio-group formControlName="taxResidency" class="onboarding__radio-group">
              @for (option of taxResidencyOptions; track option.value) {
                <mat-radio-button [value]="option.value" class="onboarding__radio-option">
                  <div class="onboarding__radio-content">
                    <span class="onboarding__radio-label">{{ option.label }}</span>
                    <span class="onboarding__radio-desc">{{ option.description }}</span>
                  </div>
                </mat-radio-button>
              }
            </mat-radio-group>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Marginal Tax Rate (optional)</mat-label>
            <mat-select formControlName="marginalTaxRate">
              <mat-option [value]="null">Select your tax bracket...</mat-option>
              @for (bracket of taxBrackets; track bracket.rate) {
                <mat-option [value]="bracket.value">{{ bracket.label }}</mat-option>
              }
            </mat-select>
            <mat-icon matPrefix>percent</mat-icon>
            <mat-hint>We'll use this for tax benefit calculations</mat-hint>
          </mat-form-field>

          <div class="onboarding__actions onboarding__actions--split">
            <button
              mat-stroked-button
              type="button"
              (click)="previousStep()"
            >
              Back
            </button>
            <button
              mat-flat-button
              color="primary"
              type="button"
              [disabled]="!canProceedFromStep2()"
              (click)="nextStep()"
            >
              Continue
            </button>
          </div>
        </div>
      }

      <!-- Step 3: Preferences -->
      @if (currentStep() === 3) {
        <div class="onboarding__step">
          <h2 class="onboarding__step-title">Final details</h2>

          <div class="form-section">
            <mat-checkbox formControlName="hasPrivateHealthInsurance" color="primary">
              I have private health insurance
            </mat-checkbox>
            <p class="form-hint">Affects Medicare Levy Surcharge calculations</p>
          </div>

          <mat-form-field appearance="outline" class="field-narrow">
            <mat-label>Target Retirement Age</mat-label>
            <input matInput type="number" formControlName="retirementAge" min="55" max="100">
            <mat-icon matPrefix>elderly</mat-icon>
            <mat-hint>Used for FIRE and super projections</mat-hint>
          </mat-form-field>

          <div class="onboarding__actions onboarding__actions--split">
            <button
              mat-stroked-button
              type="button"
              (click)="previousStep()"
            >
              Back
            </button>
            <button
              mat-flat-button
              color="primary"
              type="submit"
              [disabled]="isSubmitting()"
            >
              @if (isSubmitting()) {
                <mat-spinner diameter="20"></mat-spinner>
                <span>Completing...</span>
              } @else {
                Complete Setup
              }
            </button>
          </div>
        </div>
      }
    </form>
  </mat-card>
</div>
