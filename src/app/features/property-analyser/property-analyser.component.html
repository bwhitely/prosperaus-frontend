<div class="property-analyser">
  <header class="page-header">
    <h1>Investment Property Analyser</h1>
    <p>Model cash flow, tax benefits, and compare against ETF alternatives</p>
  </header>

  <div class="analyser-grid">
    <!-- Input Form -->
    <div class="form-panel">
      <form [formGroup]="form" class="property-form">
        <!-- Purchase Details -->
        <section class="form-section">
          <h3 class="section-title">Purchase Details</h3>

          <div class="form-group">
            <label for="purchasePrice">Purchase Price</label>
            <div class="input-with-prefix">
              <span class="prefix">$</span>
              <input type="number" id="purchasePrice" formControlName="purchasePrice" />
            </div>
          </div>

          <div class="form-group">
            <label for="depositAmount">Deposit Amount</label>
            <div class="input-with-prefix">
              <span class="prefix">$</span>
              <input type="number" id="depositAmount" formControlName="depositAmount" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="stampDuty">Stamp Duty</label>
              <div class="input-with-prefix">
                <span class="prefix">$</span>
                <input type="number" id="stampDuty" formControlName="stampDuty" />
              </div>
            </div>

            <div class="form-group">
              <label for="otherPurchaseCosts">Other Costs</label>
              <div class="input-with-prefix">
                <span class="prefix">$</span>
                <input type="number" id="otherPurchaseCosts" formControlName="otherPurchaseCosts" />
              </div>
            </div>
          </div>
        </section>

        <!-- Loan Details -->
        <section class="form-section">
          <h3 class="section-title">Loan Details</h3>

          <div class="form-row">
            <div class="form-group">
              <label for="interestRate">Interest Rate</label>
              <div class="input-with-suffix">
                <input type="number" id="interestRate" formControlName="interestRate" step="0.1" />
                <span class="suffix">%</span>
              </div>
            </div>

            <div class="form-group">
              <label for="loanTermYears">Loan Term</label>
              <div class="input-with-suffix">
                <input type="number" id="loanTermYears" formControlName="loanTermYears" />
                <span class="suffix">years</span>
              </div>
            </div>
          </div>

          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" formControlName="isInterestOnly" />
              <span>Interest-only loan</span>
            </label>
          </div>

          @if (form.get('isInterestOnly')?.value) {
            <div class="form-group">
              <label for="interestOnlyPeriodYears">Interest-only Period</label>
              <div class="input-with-suffix">
                <input type="number" id="interestOnlyPeriodYears" formControlName="interestOnlyPeriodYears" />
                <span class="suffix">years</span>
              </div>
            </div>
          }
        </section>

        <!-- Rental Income -->
        <section class="form-section">
          <h3 class="section-title">Rental Income</h3>

          <div class="form-group">
            <label for="weeklyRent">Weekly Rent</label>
            <div class="input-with-prefix">
              <span class="prefix">$</span>
              <input type="number" id="weeklyRent" formControlName="weeklyRent" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="vacancyRate">Vacancy Rate</label>
              <div class="input-with-suffix">
                <input type="number" id="vacancyRate" formControlName="vacancyRate" step="0.5" />
                <span class="suffix">%</span>
              </div>
            </div>

            <div class="form-group">
              <label for="rentGrowthRate">Rent Growth</label>
              <div class="input-with-suffix">
                <input type="number" id="rentGrowthRate" formControlName="rentGrowthRate" step="0.5" />
                <span class="suffix">%</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Annual Expenses -->
        <section class="form-section">
          <h3 class="section-title">Annual Expenses</h3>

          <div class="form-row">
            <div class="form-group">
              <label for="councilRates">Council Rates</label>
              <div class="input-with-prefix">
                <span class="prefix">$</span>
                <input type="number" id="councilRates" formControlName="councilRates" />
              </div>
            </div>

            <div class="form-group">
              <label for="waterRates">Water Rates</label>
              <div class="input-with-prefix">
                <span class="prefix">$</span>
                <input type="number" id="waterRates" formControlName="waterRates" />
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="strataFees">Strata Fees</label>
              <div class="input-with-prefix">
                <span class="prefix">$</span>
                <input type="number" id="strataFees" formControlName="strataFees" />
              </div>
            </div>

            <div class="form-group">
              <label for="insurance">Insurance</label>
              <div class="input-with-prefix">
                <span class="prefix">$</span>
                <input type="number" id="insurance" formControlName="insurance" />
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="maintenance">Maintenance</label>
              <div class="input-with-prefix">
                <span class="prefix">$</span>
                <input type="number" id="maintenance" formControlName="maintenance" />
              </div>
            </div>

            <div class="form-group">
              <label for="managementFeeRate">Management Fee</label>
              <div class="input-with-suffix">
                <input type="number" id="managementFeeRate" formControlName="managementFeeRate" step="0.5" />
                <span class="suffix">%</span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="otherExpenses">Other Expenses</label>
            <div class="input-with-prefix">
              <span class="prefix">$</span>
              <input type="number" id="otherExpenses" formControlName="otherExpenses" />
            </div>
          </div>
        </section>

        <!-- Tax & Growth -->
        <section class="form-section">
          <h3 class="section-title">Tax & Growth</h3>

          <div class="form-group">
            <label for="marginalTaxRate">Marginal Tax Rate</label>
            <select id="marginalTaxRate" formControlName="marginalTaxRate">
              @for (bracket of taxBrackets; track bracket.value) {
                <option [value]="bracket.value">{{ bracket.label }}</option>
              }
            </select>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="capitalGrowthRate">Capital Growth</label>
              <div class="input-with-suffix">
                <input type="number" id="capitalGrowthRate" formControlName="capitalGrowthRate" step="0.5" />
                <span class="suffix">%</span>
              </div>
            </div>

            <div class="form-group">
              <label for="annualDepreciation">Annual Depreciation</label>
              <div class="input-with-prefix">
                <span class="prefix">$</span>
                <input type="number" id="annualDepreciation" formControlName="annualDepreciation" />
              </div>
            </div>
          </div>
        </section>

        <!-- Comparison Settings -->
        <section class="form-section">
          <h3 class="section-title">Comparison</h3>

          <div class="form-row">
            <div class="form-group">
              <label for="etfReturnRate">ETF Return Rate</label>
              <div class="input-with-suffix">
                <input type="number" id="etfReturnRate" formControlName="etfReturnRate" step="0.5" />
                <span class="suffix">%</span>
              </div>
            </div>

            <div class="form-group">
              <label for="projectionYears">Projection Years</label>
              <div class="input-with-suffix">
                <input type="number" id="projectionYears" formControlName="projectionYears" min="1" max="30" />
                <span class="suffix">years</span>
              </div>
            </div>
          </div>
        </section>
      </form>
    </div>

    <!-- Results Panel -->
    <div class="results-panel">
      @if (isLoading()) {
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Analysing property...</p>
        </div>
      } @else if (error()) {
        <div class="error-state">
          <p>{{ error() }}</p>
          <button class="btn btn--primary" (click)="calculate()">Retry</button>
        </div>
      } @else if (result(); as r) {
        <!-- Summary Cards -->
        <div class="summary-cards">
          <div class="summary-card" [class.negative]="r.isNegativelyGeared">
            <span class="label">{{ r.isNegativelyGeared ? 'Negatively Geared' : 'Positively Geared' }}</span>
            <span class="value" [class.negative]="r.netPositionAfterTax < 0">
              {{ formatCurrency(r.netPositionAfterTax) }}
            </span>
            <span class="sublabel">Net position after tax (Year 1)</span>
          </div>

          <div class="summary-card">
            <span class="label">{{ weeklyNetCostFormatted()?.label }}</span>
            <span class="value" [class.positive]="!weeklyNetCostFormatted()?.isOutOfPocket" [class.negative]="weeklyNetCostFormatted()?.isOutOfPocket">
              {{ formatCurrency(weeklyNetCostFormatted()?.value ?? 0) }}
            </span>
            <span class="sublabel">After tax benefits</span>
          </div>

          <div class="summary-card">
            <span class="label">Gross Yield</span>
            <span class="value">{{ formatPercent(r.grossYield) }}</span>
            <span class="sublabel">Annual rent / price</span>
          </div>

          <div class="summary-card">
            <span class="label">Cash-on-Cash Return</span>
            <span class="value" [class.negative]="r.cashOnCashReturn < 0">{{ formatPercent(r.cashOnCashReturn) }}</span>
            <span class="sublabel">Cash flow / upfront costs</span>
          </div>
        </div>

        <!-- Insights -->
        @if (r.insights && r.insights.length > 0) {
          <div class="insights-section">
            <h3>Key Insights</h3>
            <ul class="insights-list">
              @for (insight of r.insights; track insight) {
                <li class="insight-item" [class]="getInsightIcon(insight)">
                  {{ insight }}
                </li>
              }
            </ul>
          </div>
        }

        <!-- Tabs -->
        <div class="tabs">
          <button
            class="tab"
            [class.active]="activeTab() === 'summary'"
            (click)="setTab('summary')">
            Loan & Costs
          </button>
          <button
            class="tab"
            [class.active]="activeTab() === 'cashflow'"
            (click)="setTab('cashflow')">
            Cash Flow
          </button>
          <button
            class="tab"
            [class.active]="activeTab() === 'projections'"
            (click)="setTab('projections')">
            Projections
          </button>
          <button
            class="tab"
            [class.active]="activeTab() === 'comparison'"
            (click)="setTab('comparison')">
            vs ETF
          </button>
          <button
            class="tab"
            [class.active]="activeTab() === 'cgt'"
            (click)="setTab('cgt')">
            CGT
          </button>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
          <!-- Summary Tab -->
          @if (activeTab() === 'summary') {
            <div class="detail-section">
              <h4>Loan Details</h4>
              <div class="detail-grid">
                <div class="detail-row">
                  <span class="label">Loan Amount</span>
                  <span class="value">{{ formatCurrency(r.loanAmount) }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Monthly Repayment</span>
                  <span class="value">{{ formatCurrency(r.monthlyRepayment) }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Annual Interest (Year 1)</span>
                  <span class="value">{{ formatCurrency(r.annualInterest) }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Loan-to-Value Ratio (LVR)</span>
                  <span class="value">{{ formatPercent(r.lvr) }}</span>
                </div>
              </div>
            </div>

            <div class="detail-section">
              <h4>Upfront Costs</h4>
              <div class="detail-grid">
                <div class="detail-row">
                  <span class="label">Total Upfront Costs</span>
                  <span class="value">{{ formatCurrency(r.totalUpfrontCosts) }}</span>
                </div>
              </div>
            </div>

            <div class="detail-section">
              <h4>Tax Benefits (Year 1)</h4>
              <div class="detail-grid">
                <div class="detail-row">
                  <span class="label">Total Deductions</span>
                  <span class="value">{{ formatCurrency(r.totalDeductions) }}</span>
                </div>
                <div class="detail-row highlight">
                  <span class="label">Tax Benefit (Refund)</span>
                  <span class="value positive">{{ formatCurrency(r.taxBenefit) }}</span>
                </div>
              </div>
            </div>

            <div class="detail-section">
              <h4>Yields</h4>
              <div class="detail-grid">
                <div class="detail-row">
                  <span class="label">Gross Yield</span>
                  <span class="value">{{ formatPercent(r.grossYield) }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Net Yield</span>
                  <span class="value">{{ formatPercent(r.netYield) }}</span>
                </div>
              </div>
            </div>
          }

          <!-- Cash Flow Tab -->
          @if (activeTab() === 'cashflow') {
            <div class="detail-section">
              <h4>Year 1 Cash Flow Breakdown</h4>
              <div class="cashflow-table">
                <div class="cashflow-section income">
                  <h5>Income</h5>
                  <div class="cashflow-row">
                    <span>Gross Rent (52 weeks)</span>
                    <span class="amount positive">{{ formatCurrency(r.year1CashFlow.grossRent) }}</span>
                  </div>
                  <div class="cashflow-row">
                    <span>Less: Vacancy Allowance</span>
                    <span class="amount negative">({{ formatCurrency(r.year1CashFlow.vacancyAllowance) }})</span>
                  </div>
                  <div class="cashflow-row subtotal">
                    <span>Net Rent</span>
                    <span class="amount">{{ formatCurrency(r.year1CashFlow.netRent) }}</span>
                  </div>
                </div>

                <div class="cashflow-section expenses">
                  <h5>Expenses</h5>
                  <div class="cashflow-row">
                    <span>Council Rates</span>
                    <span class="amount negative">({{ formatCurrency(r.year1CashFlow.councilRates) }})</span>
                  </div>
                  <div class="cashflow-row">
                    <span>Water Rates</span>
                    <span class="amount negative">({{ formatCurrency(r.year1CashFlow.waterRates) }})</span>
                  </div>
                  <div class="cashflow-row">
                    <span>Strata Fees</span>
                    <span class="amount negative">({{ formatCurrency(r.year1CashFlow.strataFees) }})</span>
                  </div>
                  <div class="cashflow-row">
                    <span>Insurance</span>
                    <span class="amount negative">({{ formatCurrency(r.year1CashFlow.insurance) }})</span>
                  </div>
                  <div class="cashflow-row">
                    <span>Maintenance</span>
                    <span class="amount negative">({{ formatCurrency(r.year1CashFlow.maintenance) }})</span>
                  </div>
                  <div class="cashflow-row">
                    <span>Management Fees</span>
                    <span class="amount negative">({{ formatCurrency(r.year1CashFlow.managementFees) }})</span>
                  </div>
                  <div class="cashflow-row">
                    <span>Other Expenses</span>
                    <span class="amount negative">({{ formatCurrency(r.year1CashFlow.otherExpenses) }})</span>
                  </div>
                  <div class="cashflow-row subtotal">
                    <span>Total Expenses</span>
                    <span class="amount negative">({{ formatCurrency(r.year1CashFlow.totalExpenses) }})</span>
                  </div>
                </div>

                <div class="cashflow-section deductions">
                  <h5>Tax Deductions</h5>
                  <div class="cashflow-row">
                    <span>Interest Payments</span>
                    <span class="amount">{{ formatCurrency(r.year1CashFlow.interestPayments) }}</span>
                  </div>
                  <div class="cashflow-row">
                    <span>Depreciation</span>
                    <span class="amount">{{ formatCurrency(r.year1CashFlow.depreciation) }}</span>
                  </div>
                  <div class="cashflow-row subtotal">
                    <span>Total Deductions</span>
                    <span class="amount">{{ formatCurrency(r.year1CashFlow.totalDeductions) }}</span>
                  </div>
                </div>

                <div class="cashflow-section summary">
                  <div class="cashflow-row total">
                    <span>Net Cash Flow (before tax)</span>
                    <span class="amount" [class.negative]="r.year1CashFlow.netCashFlow < 0">
                      {{ formatCurrency(r.year1CashFlow.netCashFlow) }}
                    </span>
                  </div>
                  <div class="cashflow-row">
                    <span>Taxable Income (for property)</span>
                    <span class="amount">{{ formatCurrency(r.year1CashFlow.taxableIncome) }}</span>
                  </div>
                </div>
              </div>
            </div>
          }

          <!-- Projections Tab -->
          @if (activeTab() === 'projections') {
            <div class="detail-section">
              <h4>{{ projectionYearsValue }}-Year Projection</h4>
              <div class="projections-table-wrapper">
                <table class="projections-table">
                  <thead>
                    <tr>
                      <th>Year</th>
                      <th>Property Value</th>
                      <th>Loan Balance</th>
                      <th>Equity</th>
                      <th>Net Cash Flow</th>
                      <th>Tax Benefit</th>
                      <th>Net After Tax</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (proj of r.projections; track proj.year) {
                      <tr>
                        <td>{{ proj.year }}</td>
                        <td>{{ formatCurrency(proj.propertyValue) }}</td>
                        <td>{{ formatCurrency(proj.loanBalance) }}</td>
                        <td class="positive">{{ formatCurrency(proj.equity) }}</td>
                        <td [class.negative]="proj.netCashFlow < 0">{{ formatCurrency(proj.netCashFlow) }}</td>
                        <td class="positive">{{ formatCurrency(proj.taxBenefit) }}</td>
                        <td [class.negative]="proj.netPositionAfterTax < 0">{{ formatCurrency(proj.netPositionAfterTax) }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>

              <div class="projection-summary">
                <div class="summary-item">
                  <span class="label">Cumulative Equity Growth</span>
                  <span class="value positive">{{ formatCurrency(r.projections[r.projections.length - 1]?.cumulativeEquityGrowth ?? 0) }}</span>
                </div>
                <div class="summary-item">
                  <span class="label">Cumulative Cash Flow</span>
                  <span class="value" [class.negative]="(r.projections[r.projections.length - 1]?.cumulativeCashFlow ?? 0) < 0">
                    {{ formatCurrency(r.projections[r.projections.length - 1]?.cumulativeCashFlow ?? 0) }}
                  </span>
                </div>
              </div>
            </div>
          }

          <!-- ETF Comparison Tab -->
          @if (activeTab() === 'comparison') {
            <div class="detail-section">
              <h4>Property vs ETF Comparison</h4>
              <p class="comparison-intro">
                Comparing investing {{ formatCurrency(r.etfComparison.initialInvestment) }} in this property
                vs investing the same amount in ETFs at {{ formatPercent(r.etfComparison.returnRate) }} p.a.
              </p>

              <div class="comparison-result" [class.property-wins]="r.etfComparison.winner === 'PROPERTY'" [class.etf-wins]="r.etfComparison.winner === 'ETF'">
                <div class="winner-badge">
                  {{ r.etfComparison.winner === 'PROPERTY' ? 'Property Wins' : r.etfComparison.winner === 'ETF' ? 'ETF Wins' : 'Tie' }}
                </div>
                <div class="difference">
                  by {{ formatCurrency(Math.abs(r.etfComparison.difference)) }}
                </div>
              </div>

              <div class="comparison-grid">
                <div class="comparison-card property">
                  <h5>Property</h5>
                  <div class="metric">
                    <span class="label">Total Return</span>
                    <span class="value">{{ formatCurrency(r.etfComparison.propertyTotalReturn) }}</span>
                  </div>
                  <div class="metric">
                    <span class="label">Annualised Return</span>
                    <span class="value">{{ formatPercent(r.etfComparison.propertyAnnualisedReturn) }}</span>
                  </div>
                </div>

                <div class="comparison-card etf">
                  <h5>ETF Portfolio</h5>
                  <div class="metric">
                    <span class="label">Total Return</span>
                    <span class="value">{{ formatCurrency(r.etfComparison.etfTotalReturn) }}</span>
                  </div>
                  <div class="metric">
                    <span class="label">Annual Return (assumed)</span>
                    <span class="value">{{ formatPercent(r.etfComparison.returnRate) }}</span>
                  </div>
                </div>
              </div>

              <div class="etf-yearly-table">
                <h5>ETF Growth Over Time</h5>
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Year</th>
                      <th>ETF Value</th>
                      <th>Total Growth</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (year of r.etfComparison.yearlyValues; track year.year) {
                      <tr>
                        <td>{{ year.year }}</td>
                        <td>{{ formatCurrency(year.value) }}</td>
                        <td class="positive">{{ formatCurrency(year.totalGrowth) }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          }

          <!-- CGT Tab -->
          @if (activeTab() === 'cgt') {
            <div class="detail-section">
              <h4>Capital Gains Tax Scenarios</h4>
              <p class="cgt-intro">
                Estimated CGT payable if you sold the property after different holding periods.
                50% CGT discount applies after 12 months for individuals.
              </p>

              <div class="cgt-table-wrapper">
                <table class="cgt-table">
                  <thead>
                    <tr>
                      <th>Years Held</th>
                      <th>Sale Price</th>
                      <th>Capital Gain</th>
                      <th>Discounted Gain</th>
                      <th>CGT Payable</th>
                      <th>Net Proceeds</th>
                      <th>Total Return</th>
                      <th>Annualised</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (scenario of r.cgtScenarios; track scenario.yearsHeld) {
                      <tr>
                        <td>{{ scenario.yearsHeld }}</td>
                        <td>{{ formatCurrency(scenario.salePrice) }}</td>
                        <td class="positive">{{ formatCurrency(scenario.capitalGain) }}</td>
                        <td>{{ formatCurrency(scenario.discountedGain) }}</td>
                        <td class="negative">{{ formatCurrency(scenario.cgtPayable) }}</td>
                        <td>{{ formatCurrency(scenario.netProceeds) }}</td>
                        <td class="positive">{{ formatCurrency(scenario.totalReturn) }}</td>
                        <td>{{ formatPercent(scenario.annualisedReturn) }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>

              <div class="cgt-note">
                <strong>Note:</strong> These calculations assume you're an individual investor and the property is not your main residence.
                CGT discount of 50% applies to assets held longer than 12 months.
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="empty-state">
          <p>Enter property details to see analysis</p>
        </div>
      }
    </div>
  </div>
</div>
