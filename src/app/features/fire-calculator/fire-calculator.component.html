<div class="page-header">
  <div class="page-header__content">
    <h1>FIRE Calculator</h1>
    <p class="subtitle">Calculate your path to Financial Independence, Retire Early</p>
    @if (getCurrentScenarioName(); as name) {
      <span class="scenario-badge">{{ name }}</span>
    }
  </div>
  <div class="page-header__actions">
    <button mat-stroked-button (click)="newScenario()" [disabled]="!currentScenarioId()">
      <mat-icon>add</mat-icon>
      New
    </button>
    <button mat-stroked-button (click)="openLoadForm()" [disabled]="scenarios().length === 0">
      <mat-icon>folder_open</mat-icon>
      Load ({{ scenarios().length }})
    </button>
    <button mat-flat-button color="primary" (click)="openSaveForm()" [disabled]="!result()">
      <mat-icon>save</mat-icon>
      {{ currentScenarioId() ? 'Update' : 'Save' }}
    </button>
  </div>
</div>

@if (error()) {
  <div class="alert alert--error">
    {{ error() }}
    <button mat-icon-button (click)="error.set(null)">
      <mat-icon>close</mat-icon>
    </button>
  </div>
}

<div class="calculator-layout">
  <!-- Input Section -->
  <div class="input-section">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Your Details</mat-card-title>
        @if (isPrefilling()) {
          <span class="loading-badge">
            <mat-spinner diameter="16"></mat-spinner>
            Loading your data...
          </span>
        }
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="form">
          <!-- Personal Details -->
          <div class="form-section">
            <h3>Personal</h3>
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Current Age</mat-label>
                <input matInput type="number" formControlName="currentAge" min="18" max="80">
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Target FIRE Age (optional)</mat-label>
                <input matInput type="number" formControlName="targetRetirementAge" min="30" max="100" placeholder="Auto-calculate">
                <mat-hint>Leave blank to auto-calculate</mat-hint>
              </mat-form-field>
            </div>
          </div>

          <!-- Assets -->
          <div class="form-section">
            <h3>Current Assets</h3>
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Super Balance</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="currentSuperBalance" min="0">
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Non-Super Investments</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="currentNonSuperInvestments" min="0">
                <mat-hint>Shares, ETFs, investment properties</mat-hint>
              </mat-form-field>
            </div>
          </div>

          <!-- Income & Expenses -->
          <div class="form-section">
            <h3>Annual Cash Flow</h3>
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Gross Income</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="annualGrossIncome" min="0">
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Annual Expenses</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="annualExpenses" min="0">
              </mat-form-field>
            </div>

            <div class="savings-rate-display">
              <span class="label">Savings Rate:</span>
              <span class="value" [class.excellent]="savingsRate() >= 50" [class.good]="savingsRate() >= 20 && savingsRate() < 50">
                {{ savingsRate() | number:'1.0-0' }}%
              </span>
            </div>
          </div>

          <!-- Advanced Options -->
          <mat-expansion-panel class="advanced-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>Advanced Options</mat-panel-title>
              <mat-panel-description>Returns, contributions & more</mat-panel-description>
            </mat-expansion-panel-header>

            <!-- Super Contributions -->
            <div class="form-section">
              <h4>Super Contributions</h4>
              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>SG Rate</mat-label>
                  <input matInput type="number" formControlName="superGuaranteeRate" min="0" max="30" step="0.5">
                  <span matTextSuffix>%</span>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Salary Sacrifice p.a.</mat-label>
                  <span matTextPrefix>$&nbsp;</span>
                  <input matInput type="number" formControlName="annualSalarySacrifice" min="0">
                </mat-form-field>
              </div>
            </div>

            <!-- Return Assumptions -->
            <div class="form-section">
              <h4>Return Assumptions</h4>
              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Pre-FIRE Return</mat-label>
                  <input matInput type="number" formControlName="preRetirementReturnRate" min="0" max="20" step="0.5">
                  <span matTextSuffix>%</span>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Post-FIRE Return</mat-label>
                  <input matInput type="number" formControlName="postRetirementReturnRate" min="0" max="15" step="0.5">
                  <span matTextSuffix>%</span>
                  <mat-hint>More conservative in retirement</mat-hint>
                </mat-form-field>
              </div>
            </div>

            <!-- Other Settings -->
            <div class="form-section">
              <h4>Other Settings</h4>
              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Inflation Rate</mat-label>
                  <input matInput type="number" formControlName="inflationRate" min="0" max="10" step="0.1">
                  <span matTextSuffix>%</span>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Safe Withdrawal Rate</mat-label>
                  <input matInput type="number" formControlName="safeWithdrawalRate" min="2" max="10" step="0.1">
                  <span matTextSuffix>%</span>
                </mat-form-field>
              </div>

              <mat-checkbox formControlName="includeAgePension" color="primary">
                Include Age Pension (from age 67)
              </mat-checkbox>
              <p class="checkbox-hint">Based on asset test for homeowner singles</p>
            </div>
          </mat-expansion-panel>
        </form>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Results Section -->
  <div class="results-section">
    @if (isLoading()) {
      <mat-card class="loading-card">
        <mat-card-content>
          <mat-spinner diameter="40"></mat-spinner>
          <p>Calculating your FIRE projection...</p>
        </mat-card-content>
      </mat-card>
    } @else if (result()) {
      <!-- Summary Cards -->
      <div class="summary-cards">
        <mat-card class="summary-card fire-number-card">
          <mat-card-content>
            <mat-icon>local_fire_department</mat-icon>
            <span class="label">FIRE Number</span>
            <span class="value">{{ formatCurrency(fireNumber()) }}</span>
            <span class="subtext">{{ form.get('annualExpenses')?.value | currency:'AUD':'symbol':'1.0-0' }} / {{ form.get('safeWithdrawalRate')?.value }}%</span>
          </mat-card-content>
        </mat-card>

        @if (canAchieveFire()) {
          <mat-card class="summary-card fire-age-card">
            <mat-card-content>
              <mat-icon>celebration</mat-icon>
              <span class="label">FIRE Age</span>
              <span class="value">{{ fireAge() }}</span>
              <span class="subtext">{{ yearsToFire() }} years from now</span>
            </mat-card-content>
          </mat-card>
        } @else {
          <mat-card class="summary-card fire-age-card warning">
            <mat-card-content>
              <mat-icon>warning</mat-icon>
              <span class="label">FIRE Status</span>
              <span class="value">Not Achievable</span>
              <span class="subtext">With current inputs</span>
            </mat-card-content>
          </mat-card>
        }

        <mat-card class="summary-card assets-card">
          <mat-card-content>
            <mat-icon>account_balance</mat-icon>
            <span class="label">Assets at FIRE</span>
            <span class="value">{{ formatCurrency(totalAssetsAtFire()) }}</span>
            <span class="subtext">Safe withdrawal: {{ formatCurrency(safeWithdrawalAmount()) }}/yr</span>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Progress Card -->
      <mat-card class="progress-card">
        <mat-card-header>
          <mat-card-title>Progress to FIRE</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-progress-bar
            mode="determinate"
            [value]="getProgressToFire()"
            color="primary">
          </mat-progress-bar>
          <div class="progress-labels">
            <span class="current">
              Current: {{ formatCurrency((form.get('currentSuperBalance')?.value || 0) + (form.get('currentNonSuperInvestments')?.value || 0)) }}
            </span>
            <span class="target">
              Target: {{ formatCurrency(fireNumber()) }}
            </span>
          </div>
          <div class="progress-percent">{{ getProgressToFire() | number:'1.0-0' }}% complete</div>
        </mat-card-content>
      </mat-card>

      <!-- Insights -->
      @if (result()!.insights.length > 0) {
        <mat-card class="insights-card">
          <mat-card-header>
            <mat-card-title>Key Insights</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <ul class="insights-list">
              @for (insight of result()!.insights; track insight) {
                <li [class.warning]="insight.toLowerCase().includes('warning')">
                  <mat-icon>{{ insight.toLowerCase().includes('warning') ? 'warning' : 'lightbulb' }}</mat-icon>
                  {{ insight }}
                </li>
              }
            </ul>
          </mat-card-content>
        </mat-card>
      }

      <!-- Milestones -->
      <mat-card class="milestones-card">
        <mat-card-header>
          <mat-card-title>Key Milestones</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="milestones-grid">
            @if (canAchieveFire()) {
              <div class="milestone fire-milestone">
                <div class="milestone-age">{{ fireAge() }}</div>
                <div class="milestone-label">FIRE</div>
                <div class="milestone-detail">
                  Super: {{ formatCurrency(result()!.superBalanceAtFire) }}<br>
                  Non-Super: {{ formatCurrency(result()!.nonSuperBalanceAtFire) }}
                </div>
              </div>
            }
            <div class="milestone preservation-milestone">
              <div class="milestone-age">60</div>
              <div class="milestone-label">Super Access</div>
              <div class="milestone-detail">
                Super: {{ formatCurrency(result()!.superBalanceAtPreservation) }}<br>
                Non-Super: {{ formatCurrency(result()!.nonSuperBalanceAtPreservation) }}
              </div>
            </div>
            <div class="milestone pension-milestone">
              <div class="milestone-age">67</div>
              <div class="milestone-label">Age Pension</div>
              <div class="milestone-detail">
                Estimated: {{ formatCurrency(result()!.estimatedAgePensionPerYear) }}/yr
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Year-by-Year Projections -->
      <mat-card class="projections-card">
        <mat-card-header>
          <mat-card-title>Year-by-Year Projection</mat-card-title>
          <button mat-stroked-button (click)="toggleAllProjections()">
            {{ showAllProjections() ? 'Show Milestones' : 'Show All Years' }}
          </button>
        </mat-card-header>
        <mat-card-content>
          <div class="table-container">
            <table class="projections-table">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Age</th>
                  <th>Super</th>
                  <th>Non-Super</th>
                  <th>Total</th>
                  <th>Phase</th>
                </tr>
              </thead>
              <tbody>
                @for (projection of displayedProjections(); track projection.year) {
                  <tr [class]="getRowClass(projection)">
                    <td>{{ projection.year }}</td>
                    <td>{{ projection.age }}</td>
                    <td>{{ projection.superBalance | currency:'AUD':'symbol':'1.0-0' }}</td>
                    <td>{{ projection.nonSuperBalance | currency:'AUD':'symbol':'1.0-0' }}</td>
                    <td class="total">{{ projection.totalAssets | currency:'AUD':'symbol':'1.0-0' }}</td>
                    <td>
                      <span class="phase-badge" [class.accumulating]="!projection.hasFired" [class.fired]="projection.hasFired">
                        {{ getPhaseLabel(projection) }}
                      </span>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </mat-card-content>
      </mat-card>
    }
  </div>
</div>

<!-- Save Scenario Inline Form -->
@if (showSaveForm()) {
  <mat-card class="inline-form">
    <mat-card-header class="inline-form__header">
      <mat-card-title>{{ currentScenarioId() ? 'Update' : 'Save' }} Scenario</mat-card-title>
    </mat-card-header>
    <mat-card-content class="inline-form__body">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Scenario Name</mat-label>
        <input
          matInput
          type="text"
          [value]="scenarioName()"
          (input)="scenarioName.set($any($event.target).value)"
          placeholder="e.g., Conservative FIRE Plan"
          maxlength="100">
      </mat-form-field>
    </mat-card-content>
    <mat-card-actions align="end" class="inline-form__footer">
      <button mat-stroked-button (click)="closeSaveForm()">Cancel</button>
      <button
        mat-flat-button
        color="primary"
        (click)="saveScenario()"
        [disabled]="!scenarioName().trim() || isSaving()">
        @if (isSaving()) {
          <mat-spinner diameter="18"></mat-spinner>
        }
        {{ isSaving() ? 'Saving...' : 'Save' }}
      </button>
    </mat-card-actions>
  </mat-card>
}

<!-- Load Scenario Inline Form -->
@if (showLoadForm()) {
  <mat-card class="inline-form">
    <mat-card-header class="inline-form__header">
      <mat-card-title>Load Scenario</mat-card-title>
    </mat-card-header>
    <mat-card-content class="inline-form__body">
      @if (scenarios().length === 0) {
        <p class="empty-message">No saved scenarios yet.</p>
      } @else {
        <div class="scenario-list">
          @for (scenario of scenarios(); track scenario.id) {
            <div
              class="scenario-item"
              [class.scenario-item--active]="scenario.id === currentScenarioId()"
              (click)="loadScenario(scenario)">
              <div class="scenario-item__info">
                <div class="scenario-item__name">{{ scenario.name }}</div>
                <div class="scenario-item__date">Last updated: {{ scenario.updatedAt | date:'medium' }}</div>
              </div>
              <button
                mat-icon-button
                color="warn"
                (click)="deleteScenario(scenario, $event)"
                matTooltip="Delete scenario">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          }
        </div>
      }
    </mat-card-content>
    <mat-card-actions align="end" class="inline-form__footer">
      <button mat-stroked-button (click)="closeLoadForm()">Close</button>
    </mat-card-actions>
  </mat-card>
}
