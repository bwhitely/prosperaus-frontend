<div class="page-header">
  <h1>Super Optimiser</h1>
  <p class="subtitle">Maximise your superannuation contributions and tax savings</p>
</div>

@if (error()) {
  <div class="alert alert--error">
    {{ error() }}
    <button mat-icon-button (click)="error.set(null)">
      <mat-icon>close</mat-icon>
    </button>
  </div>
}

<div class="optimiser-layout">
  <!-- Input Section -->
  <div class="input-section">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Your Details</mat-card-title>
        @if (isPrefilling()) {
          <span class="loading-badge">
            <mat-spinner diameter="16"></mat-spinner>
            Loading your data...
          </span>
        }
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="form">
          <!-- Income & Super Balance -->
          <div class="form-section">
            <h3>Income & Super</h3>
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Annual Gross Income</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="annualGrossIncome" min="0">
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Current Super Balance</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="currentSuperBalance" min="0">
              </mat-form-field>
            </div>
          </div>

          <!-- Contributions YTD -->
          <div class="form-section">
            <h3>Contributions This Financial Year</h3>
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Employer SG (YTD)</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="employerContributionsYtd" min="0">
                <mat-hint>Super guarantee from your employer</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Salary Sacrifice (YTD)</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="salarySacrificeYtd" min="0">
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Personal Deductible (YTD)</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="personalConcessionalYtd" min="0">
                <mat-hint>Personal contributions you'll claim as a tax deduction</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Non-Concessional (YTD)</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="nonConcessionalYtd" min="0">
                <mat-hint>After-tax contributions</mat-hint>
              </mat-form-field>
            </div>

            <!-- Cap Progress -->
            <div class="cap-progress">
              <div class="cap-header">
                <span class="label">Concessional Cap Used</span>
                <span class="value">{{ formatCurrency(totalConcessionalYtd()) }} / $30,000</span>
              </div>
              <mat-progress-bar
                mode="determinate"
                [value]="getProgressPercent()"
                [color]="getProgressPercent() > 100 ? 'warn' : 'primary'">
              </mat-progress-bar>
              <div class="cap-remaining">
                Remaining: {{ formatCurrency(remainingCap()) }}
              </div>
            </div>
          </div>

          <!-- Spouse Section -->
          <mat-expansion-panel class="section-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>Spouse Details</mat-panel-title>
              <mat-panel-description>For spouse contribution tax offset calculations</mat-panel-description>
            </mat-expansion-panel-header>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Spouse Annual Income</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="spouseIncome" min="0" placeholder="Optional">
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Spouse Super Balance</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="spouseSuperBalance" min="0" placeholder="Optional">
              </mat-form-field>
            </div>
          </mat-expansion-panel>

          <!-- Advanced Options -->
          <mat-expansion-panel class="section-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>Advanced Options</mat-panel-title>
              <mat-panel-description>Carry-forward, tax rates & more</mat-panel-description>
            </mat-expansion-panel-header>

            <!-- Carry-forward -->
            <div class="form-section">
              <h4>Carry-Forward Unused Cap</h4>
              <p class="section-hint">Available if your total super was under $500k on 30 June last year</p>
              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Unused Cap (Total)</mat-label>
                  <span matTextPrefix>$&nbsp;</span>
                  <input matInput type="number" formControlName="unusedConcessionalCapTotal" min="0">
                  <mat-hint>Check your ATO online account for exact amounts</mat-hint>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Super Balance (30 June)</mat-label>
                  <span matTextPrefix>$&nbsp;</span>
                  <input matInput type="number" formControlName="totalSuperBalancePrevFy" min="0" placeholder="Optional">
                  <mat-hint>Your total super balance at end of last FY</mat-hint>
                </mat-form-field>
              </div>
            </div>

            <!-- Other Settings -->
            <div class="form-section">
              <h4>Other Details</h4>
              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Your Age</mat-label>
                  <input matInput type="number" formControlName="age" min="18" max="100" placeholder="Optional">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Marginal Tax Rate</mat-label>
                  <mat-select formControlName="marginalTaxRate">
                    <mat-option [value]="null">Auto-calculate</mat-option>
                    <mat-option [value]="0.16">16%</mat-option>
                    <mat-option [value]="0.30">30%</mat-option>
                    <mat-option [value]="0.37">37%</mat-option>
                    <mat-option [value]="0.45">45%</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <mat-checkbox formControlName="wantsToMaximiseContributions" color="primary">
                I want to maximise contributions (use carry-forward if available)
              </mat-checkbox>
            </div>
          </mat-expansion-panel>
        </form>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Results Section -->
  <div class="results-section">
    @if (isLoading()) {
      <mat-card class="loading-card">
        <mat-card-content>
          <mat-spinner diameter="40"></mat-spinner>
          <p>Analysing your super...</p>
        </mat-card-content>
      </mat-card>
    } @else if (result()) {
      <!-- Warnings -->
      @if (warnings().length > 0) {
        <div class="warnings-card">
          @for (warning of warnings(); track warning) {
            <div class="warning-item">
              <mat-icon>warning</mat-icon>
              {{ warning }}
            </div>
          }
        </div>
      }

      <!-- Key Metrics -->
      <div class="summary-cards">
        <mat-card class="summary-card primary-card">
          <mat-card-content>
            <span class="label">Suggested Contribution</span>
            <span class="value">{{ formatCurrency(suggestedContribution()) }}</span>
            <span class="subtext">Additional salary sacrifice this FY</span>
          </mat-card-content>
        </mat-card>

        <mat-card class="summary-card savings-card">
          <mat-card-content>
            <span class="label">Estimated Tax Saving</span>
            <span class="value positive">{{ formatCurrency(taxSaving()) }}</span>
            <span class="subtext">At your marginal rate of {{ marginalRate() | number:'1.0-0' }}%</span>
          </mat-card-content>
        </mat-card>

        <mat-card class="summary-card contribution-room-card">
          <mat-card-content>
            <span class="label">Total Contribution Room</span>
            <span class="value">{{ formatCurrency(result()!.totalContributionRoom) }}</span>
            <span class="subtext">
              @if (result()!.eligibleForCarryForward && result()!.carryForwardAvailable > 0) {
                Includes {{ formatCurrency(result()!.carryForwardAvailable) }} carry-forward
              } @else {
                Standard cap: $30,000
              }
            </span>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Recommendations -->
      @if (recommendations().length > 0) {
        <mat-card class="recommendations-card">
          <mat-card-header>
            <mat-card-title>Recommendations</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="recommendations-list">
              @for (rec of recommendations(); track rec.title) {
                <div class="recommendation-item" [class]="getPriorityClass(rec.priority)">
                  <div class="rec-header">
                    <span class="rec-priority">{{ rec.priority }}</span>
                    <h4>{{ rec.title }}</h4>
                  </div>
                  <p class="rec-description">{{ rec.description }}</p>
                  <div class="rec-action">
                    <span class="action-label">Action:</span>
                    <span>{{ rec.action }}</span>
                  </div>
                  @if (rec.estimatedBenefit > 0) {
                    <div class="rec-benefit">
                      Potential benefit: <span class="benefit-value">{{ formatCurrency(rec.estimatedBenefit) }}</span>
                    </div>
                  }
                </div>
              }
            </div>
          </mat-card-content>
        </mat-card>
      }

      <!-- Detailed Breakdown -->
      <mat-card class="details-card">
        <mat-card-header>
          <mat-card-title>Detailed Analysis</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="details-grid">
            <!-- Concessional -->
            <div class="detail-section">
              <h4>Concessional Contributions</h4>
              <div class="detail-row">
                <span class="detail-label">YTD Contributions</span>
                <span class="detail-value">{{ formatCurrency(result()!.totalConcessionalYtd) }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Remaining Cap</span>
                <span class="detail-value">{{ formatCurrency(result()!.remainingConcessionalCap) }}</span>
              </div>
              @if (result()!.eligibleForCarryForward) {
                <div class="detail-row highlight">
                  <span class="detail-label">Carry-Forward Available</span>
                  <span class="detail-value">{{ formatCurrency(result()!.carryForwardAvailable) }}</span>
                </div>
              }
              <div class="detail-row total">
                <span class="detail-label">Total Room</span>
                <span class="detail-value">{{ formatCurrency(result()!.totalContributionRoom) }}</span>
              </div>
            </div>

            <!-- Tax Impact -->
            <div class="detail-section">
              <h4>Tax Impact</h4>
              <div class="detail-row">
                <span class="detail-label">Marginal Tax Rate</span>
                <span class="detail-value">{{ (result()!.marginalTaxRate * 100) | number:'1.0-0' }}%</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Super Tax Rate</span>
                <span class="detail-value">{{ (result()!.effectiveSuperTaxRate * 100) | number:'1.0-0' }}%</span>
              </div>
              <div class="detail-row highlight">
                <span class="detail-label">Net Benefit</span>
                <span class="detail-value positive">{{ formatCurrency(result()!.netBenefitFromContributing) }}</span>
              </div>
            </div>

            <!-- Division 293 -->
            @if (result()!.subjectToDiv293) {
              <div class="detail-section warning-section">
                <h4>Division 293</h4>
                <p class="section-note">Additional 15% tax on super contributions for high income earners</p>
                <div class="detail-row">
                  <span class="detail-label">Contributions Affected</span>
                  <span class="detail-value">{{ formatCurrency(result()!.div293ContributionsAmount) }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Additional Tax</span>
                  <span class="detail-value negative">{{ formatCurrency(result()!.div293TaxLiability) }}</span>
                </div>
              </div>
            }

            <!-- Spouse Contributions -->
            @if (result()!.spouseContributionExplanation) {
              <div class="detail-section">
                <h4>Spouse Contributions</h4>
                <p class="section-note">{{ result()!.spouseContributionExplanation }}</p>
                @if (result()!.spouseContributionRecommended) {
                  <div class="detail-row">
                    <span class="detail-label">Max Contribution</span>
                    <span class="detail-value">{{ formatCurrency(result()!.maxSpouseContribution) }}</span>
                  </div>
                  <div class="detail-row highlight">
                    <span class="detail-label">Tax Offset</span>
                    <span class="detail-value positive">{{ formatCurrency(result()!.spouseContributionTaxOffset) }}</span>
                  </div>
                }
              </div>
            }

            <!-- Co-contribution -->
            @if (result()!.coContributionExplanation) {
              <div class="detail-section">
                <h4>Government Co-contribution</h4>
                <p class="section-note">{{ result()!.coContributionExplanation }}</p>
                @if (result()!.eligibleForCoContribution) {
                  <div class="detail-row">
                    <span class="detail-label">Required Contribution</span>
                    <span class="detail-value">{{ formatCurrency(result()!.requiredNonConcessionalForMaxCoContribution) }}</span>
                  </div>
                  <div class="detail-row highlight">
                    <span class="detail-label">Government Adds</span>
                    <span class="detail-value positive">{{ formatCurrency(result()!.maxCoContribution) }}</span>
                  </div>
                }
              </div>
            }

            <!-- Non-Concessional -->
            <div class="detail-section">
              <h4>Non-Concessional Contributions</h4>
              <div class="detail-row">
                <span class="detail-label">Remaining Cap</span>
                <span class="detail-value">{{ formatCurrency(result()!.remainingNonConcessionalCap) }}</span>
              </div>
              @if (result()!.bringForwardAvailable) {
                <div class="detail-row">
                  <span class="detail-label">With Bring-Forward</span>
                  <span class="detail-value">{{ formatCurrency(result()!.maxNonConcessionalWithBringForward) }}</span>
                </div>
              }
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Info Note -->
      <div class="info-note">
        <mat-icon>info</mat-icon>
        <p>
          <strong>Note:</strong> This analysis is based on FY 2025-26 rules.
          Contribution caps and thresholds may change. Consult a financial adviser for personalised advice.
        </p>
      </div>
    }
  </div>
</div>
