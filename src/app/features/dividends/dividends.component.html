<div class="page-header">
  <div class="page-header__content">
    <h1>Dividends & Distributions</h1>
    <p>Track your dividend income and franking credits for tax time</p>
  </div>
  @if (!showForm()) {
    <button mat-flat-button color="primary" (click)="openAddForm()">+ Log Distribution</button>
  }
</div>

@if (error()) {
  <div class="alert alert--error">
    {{ error() }}
    <button mat-icon-button (click)="error.set(null)">
      <mat-icon>close</mat-icon>
    </button>
  </div>
}

@if (isLoading()) {
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading dividend data...</p>
  </div>
} @else if (summary()) {
  <!-- Summary Cards -->
  <div class="summary-cards">
    <div class="summary-card">
      <span class="summary-card__label">Financial Year</span>
      <span class="summary-card__value">{{ summary()!.financialYearDisplay }}</span>
    </div>
    <div class="summary-card summary-card--positive">
      <span class="summary-card__label">Total Dividends</span>
      <span class="summary-card__value positive">{{ summary()!.totalDividends | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
    </div>
    <div class="summary-card summary-card--positive">
      <span class="summary-card__label">Franking Credits</span>
      <span class="summary-card__value positive">{{ summary()!.totalFrankingCredits | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
    </div>
    <div class="summary-card">
      <span class="summary-card__label">Grossed Up Income</span>
      <span class="summary-card__value">{{ summary()!.totalGrossedUp | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
    </div>
  </div>

  <!-- Year Selector -->
  @if (summary()!.historicalYears.length > 1) {
    <div class="year-selector">
      @for (year of summary()!.historicalYears; track year.financialYear) {
        <button
          mat-button
          class="year-btn"
          [class.year-btn--active]="selectedYear() === year.financialYear"
          (click)="selectYear(year.financialYear)"
        >
          FY {{ year.financialYear }}
        </button>
      }
    </div>
  }

  <!-- Tabs -->
  <div class="tabs">
    <button mat-button class="tab" [class.tab--active]="activeTab() === 'summary'" (click)="setTab('summary')">
      Summary
    </button>
    <button mat-button class="tab" [class.tab--active]="activeTab() === 'list'" (click)="setTab('list')">
      All Distributions ({{ getFilteredDistributions().length }})
    </button>
    <button mat-button class="tab" [class.tab--active]="activeTab() === 'projections'" (click)="setTab('projections')">
      Projections
    </button>
    <button mat-button class="tab" [class.tab--active]="activeTab() === 'tax-report'" (click)="setTab('tax-report')">
      Tax Report
    </button>
  </div>

  <!-- Summary Tab -->
  @if (activeTab() === 'summary') {
    <div class="tab-content">
      <!-- Holdings Breakdown -->
      @if (summary()!.holdingSummaries.length > 0) {
        <div class="card">
          <div class="card__header">
            <h3>Dividends by Holding</h3>
          </div>
          <div class="card__body">
            <div class="holdings-list">
              @for (holding of summary()!.holdingSummaries; track holding.holdingId) {
                <div class="holding-row">
                  <div class="holding-info">
                    <span class="holding-ticker">{{ holding.ticker }}</span>
                    <span class="holding-name">{{ holding.securityName }}</span>
                    <span class="holding-meta">{{ holding.distributionCount }} distribution(s), {{ holding.averageFrankingPercentage * 100 | number:'1.0-0' }}% franked</span>
                  </div>
                  <div class="holding-values">
                    <span class="holding-dividends positive">{{ holding.totalDividends | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
                    <span class="holding-franking">Franking: {{ holding.totalFrankingCredits | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      } @else {
        <div class="card">
          <div class="card__body">
            <div class="empty-state">
              <p>No dividend distributions recorded yet.</p>
              <button mat-flat-button color="primary" (click)="openAddForm()">Log First Distribution</button>
            </div>
          </div>
        </div>
      }

      <!-- Tax Summary -->
      <div class="card mt-md">
        <div class="card__header">
          <h3>Tax Time Summary</h3>
          <p class="card__subtitle">Use these figures for your tax return</p>
        </div>
        <div class="card__body">
          <div class="tax-summary">
            <div class="tax-row">
              <span class="tax-label">Unfranked Dividends</span>
              <span class="tax-value">{{ getUnfrankedDividends() | currency:'AUD':'symbol-narrow':'1.2-2' }}</span>
            </div>
            <div class="tax-row">
              <span class="tax-label">Franked Dividends</span>
              <span class="tax-value">{{ getFrankedDividends() | currency:'AUD':'symbol-narrow':'1.2-2' }}</span>
            </div>
            <div class="tax-row">
              <span class="tax-label">Franking Credits</span>
              <span class="tax-value">{{ summary()!.totalFrankingCredits | currency:'AUD':'symbol-narrow':'1.2-2' }}</span>
            </div>
            <div class="tax-row tax-row--highlight">
              <span class="tax-label">Grossed Up Dividend Income</span>
              <span class="tax-value">{{ summary()!.totalGrossedUp | currency:'AUD':'symbol-narrow':'1.2-2' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- List Tab -->
  @if (activeTab() === 'list') {
    <div class="tab-content">
      @if (getFilteredDistributions().length === 0) {
        <div class="card">
          <div class="card__body">
            <div class="empty-state">
              <p>No distributions for {{ summary()!.financialYearDisplay }}.</p>
              <button mat-flat-button color="primary" (click)="openAddForm()">Log Distribution</button>
            </div>
          </div>
        </div>
      } @else {
        <div class="distributions-list">
          @for (dist of getFilteredDistributions(); track dist.id) {
            <div class="distribution-card">
              <div class="distribution-header">
                <div class="distribution-holding">
                  <span class="distribution-ticker">{{ dist.ticker }}</span>
                  <span class="distribution-type">{{ getDistributionTypeLabel(dist.distributionType) }}</span>
                </div>
                <div class="distribution-date">{{ dist.distributionDate | date:'dd MMM yyyy' }}</div>
              </div>
              <div class="distribution-body">
                <div class="distribution-detail">
                  <span class="detail-label">Amount</span>
                  <span class="detail-value">{{ dist.grossAmount | currency:'AUD':'symbol-narrow':'1.2-2' }}</span>
                </div>
                <div class="distribution-detail">
                  <span class="detail-label">Per Unit</span>
                  <span class="detail-value">{{ dist.amountPerUnit | currency:'AUD':'symbol-narrow':'1.4-4' }}</span>
                </div>
                <div class="distribution-detail">
                  <span class="detail-label">Units</span>
                  <span class="detail-value">{{ dist.unitsHeld | number:'1.0-2' }}</span>
                </div>
                <div class="distribution-detail">
                  <span class="detail-label">Franking</span>
                  <span class="detail-value">{{ dist.frankingPercentage * 100 | number:'1.0-0' }}%</span>
                </div>
                <div class="distribution-detail">
                  <span class="detail-label">Franking Credits</span>
                  <span class="detail-value positive">{{ dist.frankingCredits | currency:'AUD':'symbol-narrow':'1.2-2' }}</span>
                </div>
              </div>
              <div class="distribution-actions">
                <button mat-icon-button (click)="openEditForm(dist)" matTooltip="Edit">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="deleteDistribution(dist)" matTooltip="Delete">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          }
        </div>
      }
    </div>
  }

  <!-- Projections Tab -->
  @if (activeTab() === 'projections') {
    <div class="tab-content">
      @if (projections()) {
        <!-- Projection Summary Cards -->
        <div class="summary-cards">
          <div class="summary-card summary-card--positive">
            <span class="summary-card__label">Est. Annual Dividends</span>
            <span class="summary-card__value positive">{{ projections()!.totalProjectedDividends | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
          </div>
          <div class="summary-card summary-card--positive">
            <span class="summary-card__label">Est. Franking Credits</span>
            <span class="summary-card__value positive">{{ projections()!.totalEstimatedFrankingCredits | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
          </div>
          <div class="summary-card">
            <span class="summary-card__label">Est. Grossed Up</span>
            <span class="summary-card__value">{{ projections()!.totalGrossedUpProjected | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
          </div>
        </div>

        <!-- Per-Holding Projections -->
        @if (projections()!.holdingProjections.length > 0) {
          <div class="card">
            <div class="card__header">
              <h3>Projected Dividends by Holding</h3>
              <p class="card__subtitle">Based on current holdings and historical dividend yields</p>
            </div>
            <div class="card__body">
              <div class="projections-table">
                <div class="projections-header">
                  <span class="col-ticker">Holding</span>
                  <span class="col-value">Value</span>
                  <span class="col-yield">Yield</span>
                  <span class="col-dividend">Est. Dividend</span>
                  <span class="col-franking">Est. Franking</span>
                  <span class="col-frequency">Frequency</span>
                </div>
                @for (proj of projections()!.holdingProjections; track proj.holdingId) {
                  <div class="projections-row">
                    <div class="col-ticker">
                      <span class="projection-ticker">{{ proj.ticker }}</span>
                      <span class="projection-name">{{ proj.securityName }}</span>
                    </div>
                    <span class="col-value">{{ proj.currentValue | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
                    <span class="col-yield">{{ proj.dividendYield * 100 | number:'1.1-2' }}%</span>
                    <span class="col-dividend positive">{{ proj.projectedDividend | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
                    <span class="col-franking">{{ proj.estimatedFrankingCredits | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
                    <span class="col-frequency">{{ proj.distributionFrequency || 'Unknown' }}</span>
                  </div>
                }
              </div>
            </div>
          </div>

          <div class="disclaimer">
            <mat-icon>info</mat-icon>
            <span>Projections are estimates based on historical dividend yields and current holdings. Actual dividends may vary significantly.</span>
          </div>
        } @else {
          <div class="card">
            <div class="card__body">
              <div class="empty-state">
                <p>No projection data available. Add holdings with dividend yield information to see projections.</p>
              </div>
            </div>
          </div>
        }
      } @else {
        <div class="card">
          <div class="card__body">
            <div class="empty-state">
              <p>Loading projection data...</p>
            </div>
          </div>
        </div>
      }
    </div>
  }

  <!-- Tax Report Tab -->
  @if (activeTab() === 'tax-report') {
    <div class="tab-content">
      <div class="card">
        <div class="card__header">
          <h3>ATO Tax Return - Item 11: Dividends</h3>
          <p class="card__subtitle">FY {{ summary()!.financialYearDisplay }}</p>
        </div>
        <div class="card__body">
          <div class="tax-report">
            <div class="tax-report__row">
              <span class="tax-report__label">A. Unfranked amount</span>
              <span class="tax-report__value">{{ getUnfrankedDividends() | currency:'AUD':'symbol-narrow':'1.2-2' }}</span>
            </div>
            <div class="tax-report__row">
              <span class="tax-report__label">B. Franked amount</span>
              <span class="tax-report__value">{{ getFrankedDividends() | currency:'AUD':'symbol-narrow':'1.2-2' }}</span>
            </div>
            <div class="tax-report__row">
              <span class="tax-report__label">C. Franking credit</span>
              <span class="tax-report__value">{{ summary()!.totalFrankingCredits | currency:'AUD':'symbol-narrow':'1.2-2' }}</span>
            </div>
            <div class="tax-report__row tax-report__row--total">
              <span class="tax-report__label">Total (A + B + C)</span>
              <span class="tax-report__value">{{ summary()!.totalGrossedUp | currency:'AUD':'symbol-narrow':'1.2-2' }}</span>
            </div>
          </div>
          <div class="tax-report__actions">
            <button mat-stroked-button (click)="copyToClipboard()">
              <mat-icon>content_copy</mat-icon>
              Copy to Clipboard
            </button>
          </div>
        </div>
      </div>

      <!-- Per-Security Breakdown for Tax -->
      @if (summary()!.holdingSummaries.length > 0) {
        <div class="card mt-md">
          <div class="card__header">
            <h3>Per-Security Breakdown</h3>
            <p class="card__subtitle">Individual holding details for tax statements</p>
          </div>
          <div class="card__body">
            <div class="tax-breakdown-table">
              <div class="tax-breakdown-header">
                <span class="col-security">Security</span>
                <span class="col-unfranked">Unfranked</span>
                <span class="col-franked">Franked</span>
                <span class="col-credits">Franking Credits</span>
              </div>
              @for (holding of summary()!.holdingSummaries; track holding.holdingId) {
                <div class="tax-breakdown-row">
                  <div class="col-security">
                    <span class="security-ticker">{{ holding.ticker }}</span>
                    <span class="security-name">{{ holding.securityName }}</span>
                  </div>
                  <span class="col-unfranked">{{ getHoldingUnfranked(holding) | currency:'AUD':'symbol-narrow':'1.2-2' }}</span>
                  <span class="col-franked">{{ getHoldingFranked(holding) | currency:'AUD':'symbol-narrow':'1.2-2' }}</span>
                  <span class="col-credits">{{ holding.totalFrankingCredits | currency:'AUD':'symbol-narrow':'1.2-2' }}</span>
                </div>
              }
            </div>
          </div>
        </div>
      }

      <div class="disclaimer mt-md">
        <mat-icon>warning</mat-icon>
        <span>These figures are for reference only. Always verify against your dividend statements and consult a tax professional.</span>
      </div>
    </div>
  }
}

<!-- Inline Distribution Form -->
@if (showForm()) {
  <div class="card inline-form">
    <div class="inline-form__header">
      <h3>{{ editing() ? 'Edit' : 'Log' }} Distribution</h3>
    </div>

    <form [formGroup]="distributionForm" (ngSubmit)="saveDistribution()">
      <div class="inline-form__body">
        <div class="form-group">
          <label for="holdingId">Holding *</label>
          <select id="holdingId" formControlName="holdingId">
            <option value="">Select holding...</option>
            @for (holding of holdings(); track holding.id) {
              <option [value]="holding.id">{{ holding.ticker }} - {{ holding.securityName }}</option>
            }
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="distributionType">Type</label>
            <select id="distributionType" formControlName="distributionType">
              @for (type of distributionTypes; track type.value) {
                <option [value]="type.value">{{ type.label }}</option>
              }
            </select>
          </div>

          <div class="form-group">
            <label for="distributionDate">Distribution Date *</label>
            <input type="date" id="distributionDate" formControlName="distributionDate">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="amountPerUnit">Amount Per Unit *</label>
            <div class="input-prefix">
              <span class="prefix">$</span>
              <input type="number" id="amountPerUnit" formControlName="amountPerUnit" step="0.0001">
            </div>
          </div>

          <div class="form-group">
            <label for="unitsHeld">Units Held *</label>
            <input type="number" id="unitsHeld" formControlName="unitsHeld" step="0.0001">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="frankingPercentage">Franking Percentage</label>
            <div class="input-suffix">
              <input type="number" id="frankingPercentage" formControlName="frankingPercentage" min="0" max="100">
              <span class="suffix">%</span>
            </div>
          </div>

          <div class="form-group">
            <label for="paymentDate">Payment Date</label>
            <input type="date" id="paymentDate" formControlName="paymentDate">
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" formControlName="isDrp">
            <span>Dividend Reinvestment Plan (DRP)</span>
          </label>
        </div>

        @if (distributionForm.get('isDrp')?.value) {
          <div class="form-row">
            <div class="form-group">
              <label for="drpUnits">DRP Units Received</label>
              <input type="number" id="drpUnits" formControlName="drpUnits" step="0.0001">
            </div>
            <div class="form-group">
              <label for="drpPrice">DRP Price</label>
              <div class="input-prefix">
                <span class="prefix">$</span>
                <input type="number" id="drpPrice" formControlName="drpPrice" step="0.01">
              </div>
            </div>
          </div>
        }

        <div class="form-group">
          <label for="notes">Notes</label>
          <textarea id="notes" formControlName="notes" rows="2"></textarea>
        </div>
      </div>

      <div class="inline-form__footer">
        <button mat-stroked-button type="button" (click)="closeForm()">Cancel</button>
        <button mat-flat-button color="primary" type="submit" [disabled]="distributionForm.invalid || isSubmitting()">
          {{ isSubmitting() ? 'Saving...' : (editing() ? 'Update' : 'Log') }}
        </button>
      </div>
    </form>
  </div>
}
