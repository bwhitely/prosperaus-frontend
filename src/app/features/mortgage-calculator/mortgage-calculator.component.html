<!-- Page Header -->
<div class="page-header">
  <div class="page-header__content">
    <h1>Mortgage Calculator</h1>
    <p class="subtitle">Calculate your home loan repayments and see how offset accounts and extra repayments can save you money</p>
  </div>
</div>

<!-- Error Alert -->
@if (error()) {
  <div class="alert alert--error">
    <mat-icon>error</mat-icon>
    <span>{{ error() }}</span>
    <button mat-icon-button (click)="error.set(null)">
      <mat-icon>close</mat-icon>
    </button>
  </div>
}

<!-- Calculator Layout -->
<div class="calculator-layout">
  <!-- Inputs Column -->
  <div class="calculator-inputs">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Loan Details</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="form">
          <!-- Loan Details Section -->
          <div class="form-section">
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Loan Amount</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="loanAmount">
                @if (form.get('loanAmount')?.hasError('required')) {
                  <mat-error>Loan amount is required</mat-error>
                }
              </mat-form-field>
            </div>

            <div class="form-row form-row--double">
              <mat-form-field appearance="outline">
                <mat-label>Interest Rate</mat-label>
                <input matInput type="number" step="0.01" formControlName="interestRate" (blur)="roundInterestRateTo2dp()">
                <span matTextSuffix>%</span>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Loan Term</mat-label>
                <input matInput type="number" formControlName="loanTermYears">
                <span matTextSuffix>years</span>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Repayment Frequency</mat-label>
                <mat-select formControlName="repaymentFrequency">
                  @for (freq of repaymentFrequencies; track freq.value) {
                    <mat-option [value]="freq.value">{{ freq.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>
          </div>

          <!-- Offset Account Section -->
          <mat-expansion-panel class="options-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>savings</mat-icon>
                Offset Account
              </mat-panel-title>
              <mat-panel-description>
                Reduce interest with your savings
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="form-section">
              <p class="section-info">
                Money in your offset account reduces the interest you pay. Enter your current balance and planned contributions.
              </p>

              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Starting Balance</mat-label>
                  <span matTextPrefix>$&nbsp;</span>
                  <input matInput type="number" formControlName="offsetStartBalance">
                </mat-form-field>
              </div>

              <div class="form-row form-row--double">
                <mat-form-field appearance="outline">
                  <mat-label>Regular Contribution</mat-label>
                  <span matTextPrefix>$&nbsp;</span>
                  <input matInput type="number" formControlName="offsetContribution">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Contribution Frequency</mat-label>
                  <mat-select formControlName="offsetContributionFrequency">
                    @for (freq of repaymentFrequencies; track freq.value) {
                      <mat-option [value]="freq.value">{{ freq.label }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
          </mat-expansion-panel>

          <!-- Extra Repayments Section -->
          <mat-expansion-panel class="options-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>add_circle</mat-icon>
                Extra Repayments
              </mat-panel-title>
              <mat-panel-description>
                Pay off your loan faster
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="form-section">
              <p class="section-info">
                Extra repayments go directly to principal, reducing your loan term and total interest.
              </p>

              <div class="form-row form-row--double">
                <mat-form-field appearance="outline">
                  <mat-label>Extra Repayment Amount</mat-label>
                  <span matTextPrefix>$&nbsp;</span>
                  <input matInput type="number" formControlName="extraRepaymentAmount">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Frequency</mat-label>
                  <mat-select formControlName="extraRepaymentFrequency">
                    @for (freq of repaymentFrequencies; track freq.value) {
                      <mat-option [value]="freq.value">{{ freq.label }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="form-row form-row--double">
                <mat-form-field appearance="outline">
                  <mat-label>Lump Sum Amount</mat-label>
                  <span matTextPrefix>$&nbsp;</span>
                  <input matInput type="number" formControlName="lumpSumAmount">
                  <mat-hint>One-off payment</mat-hint>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Apply at Month</mat-label>
                  <input matInput type="number" formControlName="lumpSumMonth">
                  <mat-hint>e.g., 12 for end of year 1</mat-hint>
                </mat-form-field>
              </div>
            </div>
          </mat-expansion-panel>

          <!-- Calculate Button -->
          <button
            mat-flat-button
            color="primary"
            class="calculate-btn"
            (click)="calculate()"
            [disabled]="form.invalid || isLoading()">
            @if (isLoading()) {
              <mat-spinner diameter="20"></mat-spinner>
              Calculating...
            } @else {
              <mat-icon>calculate</mat-icon>
              Calculate
            }
          </button>
        </form>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Results Column -->
  <div class="calculator-results">
    @if (isLoading() && !result()) {
      <mat-card class="loading-card">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Calculating your mortgage...</p>
      </mat-card>
    } @else if (result(); as r) {
      <!-- Summary Cards -->
      <div class="result-cards">
        <mat-card class="result-card result-card--primary">
          <mat-card-content>
            <span class="result-label">{{ formatFrequency(r.repaymentFrequency) }} Repayment</span>
            <span class="result-value">
              {{ r.regularRepayment | currency:'AUD':'symbol-narrow':'1.0-0' }}
            </span>
          </mat-card-content>
        </mat-card>

        <mat-card class="result-card">
          <mat-card-content>
            <span class="result-label">Total Interest</span>
            <span class="result-value negative">
              {{ r.totalInterest | currency:'AUD':'symbol-narrow':'1.0-0' }}
            </span>
          </mat-card-content>
        </mat-card>

        <mat-card class="result-card">
          <mat-card-content>
            <span class="result-label">Payoff Date</span>
            <span class="result-value">{{ r.optimisedPayoffDate }}</span>
          </mat-card-content>
        </mat-card>

        @if (hasOptimisations()) {
          <mat-card class="result-card result-card--highlight">
            <mat-card-content>
              <span class="result-label">Interest Saved</span>
              <span class="result-value positive">
                {{ r.interestSaved | currency:'AUD':'symbol-narrow':'1.0-0' }}
              </span>
            </mat-card-content>
          </mat-card>
        }
      </div>

      <!-- Time Saved Banner -->
      @if (hasOptimisations()) {
        <div class="savings-banner">
          <mat-icon>schedule</mat-icon>
          <span>
            You'll pay off your loan <strong>{{ yearsAndMonthsSaved() }}</strong> earlier!
          </span>
        </div>
      }

      <!-- Chart -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Loan Balance Over Time</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #mortgageChart></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Comparison Table -->
      @if (r.comparison) {
        <mat-card class="comparison-card">
          <mat-card-header>
            <mat-card-title>Base vs Optimised</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="comparison-table">
              <div class="comparison-row comparison-row--header">
                <span></span>
                <span>Without Optimisations</span>
                <span>With Optimisations</span>
              </div>
              <div class="comparison-row">
                <span class="comparison-label">Total Interest</span>
                <span class="comparison-value">{{ r.comparison.baseTotalInterest | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
                <span class="comparison-value positive">{{ r.comparison.optimisedTotalInterest | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
              </div>
              <div class="comparison-row">
                <span class="comparison-label">Loan Term</span>
                <span class="comparison-value">{{ r.comparison.baseTermMonths }} months</span>
                <span class="comparison-value positive">{{ r.comparison.optimisedTermMonths }} months</span>
              </div>
              <div class="comparison-row comparison-row--highlight">
                <span class="comparison-label">Interest Saved</span>
                <span></span>
                <span class="comparison-value positive">{{ r.comparison.interestSaved | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      }

      <!-- Year-by-Year Breakdown -->
      <mat-card class="breakdown-card">
        <mat-card-header>
          <mat-card-title>Year-by-Year Breakdown</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="breakdown-table-wrapper">
            <table class="breakdown-table">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Principal</th>
                  <th>Interest</th>
                  <th>Balance</th>
                </tr>
              </thead>
              <tbody>
                @for (year of getYearlyData(); track year.year) {
                  <tr>
                    <td>{{ year.year }}</td>
                    <td>{{ year.principalPaid | currency:'AUD':'symbol-narrow':'1.0-0' }}</td>
                    <td>{{ year.interestPaid | currency:'AUD':'symbol-narrow':'1.0-0' }}</td>
                    <td>{{ year.endingBalance | currency:'AUD':'symbol-narrow':'1.0-0' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Insights -->
      @if (r.insights && r.insights.length > 0) {
        <mat-card class="insights-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>lightbulb</mat-icon>
              Key Insights
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <ul class="insights-list">
              @for (insight of r.insights; track insight) {
                <li>{{ insight }}</li>
              }
            </ul>
          </mat-card-content>
        </mat-card>
      }

      <!-- Disclaimer -->
      <div class="disclaimer">
        <mat-icon>info</mat-icon>
        <p>
          <strong>Important:</strong> This calculator provides estimates only. Actual repayments may vary based on
          your lender's calculations, fees, and interest rate changes. Always consult your lender for exact figures.
        </p>
      </div>
    }
  </div>
</div>
