@if (error()) {
  <div class="alert alert--error">
    {{ error() }}
    <button mat-icon-button (click)="error.set(null)">
      <mat-icon>close</mat-icon>
    </button>
  </div>
}

<div class="section-header">
  <div class="section-header__title">
    <h2>Expenses</h2>
    @if (!showCategoryForm()) {
      <button mat-stroked-button (click)="openCategoryForm()">
        <mat-icon>category</mat-icon>
        Manage Categories
      </button>
    }
  </div>
  @if (!showExpenseForm()) {
    <button mat-flat-button color="primary" (click)="openAddExpenseForm()">
      <mat-icon>add</mat-icon>
      Add Expense
    </button>
  }
</div>

<!-- Category Inline Form -->
@if (showCategoryForm()) {
  <mat-card class="inline-form">
    <mat-card-header class="inline-form__header">
      <mat-card-title>{{ editingCategory() ? 'Edit Category' : 'Add Custom Category' }}</mat-card-title>
    </mat-card-header>

    <form [formGroup]="categoryForm" (ngSubmit)="saveCategory()">
      <mat-card-content class="inline-form__body">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Name</mat-label>
          <input matInput formControlName="name" placeholder="e.g., Pet Expenses">
        </mat-form-field>

        <div class="form-row">
          <div class="color-picker-field">
            <label>Color</label>
            <input type="color" formControlName="color">
          </div>

          <mat-form-field appearance="outline">
            <mat-label>Icon</mat-label>
            <input matInput formControlName="icon" placeholder="e.g., pets">
            <mat-hint>Material icon name</mat-hint>
          </mat-form-field>
        </div>
      </mat-card-content>

      <mat-card-actions align="end" class="inline-form__footer">
        <button mat-button type="button" (click)="closeCategoryForm()">Cancel</button>
        <button mat-flat-button color="primary" type="submit" [disabled]="categoryForm.invalid || isCategorySubmitting()">
          @if (isCategorySubmitting()) {
            <mat-spinner diameter="18"></mat-spinner>
          }
          {{ isCategorySubmitting() ? 'Saving...' : (editingCategory() ? 'Update' : 'Add') }} Category
        </button>
      </mat-card-actions>
    </form>
  </mat-card>
}

<!-- Expense Inline Form -->
@if (showExpenseForm()) {
  <mat-card class="inline-form">
    <mat-card-header class="inline-form__header">
      <mat-card-title>{{ editingExpense() ? 'Edit Expense' : 'Add Expense' }}</mat-card-title>
    </mat-card-header>

    <form [formGroup]="expenseForm" (ngSubmit)="saveExpense()">
      <mat-card-content class="inline-form__body">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Name</mat-label>
          <input matInput formControlName="name" placeholder="e.g., Rent, Netflix, Electricity">
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Category</mat-label>
          <mat-select formControlName="categoryId">
            <mat-option value="">-- Select Category --</mat-option>
            @for (cat of categories(); track cat.id) {
              <mat-option [value]="cat.id">{{ cat.name }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Amount</mat-label>
            <span matTextPrefix>$&nbsp;</span>
            <input matInput type="number" formControlName="amount" step="0.01">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Frequency</mat-label>
            <mat-select formControlName="frequency">
              @for (freq of frequencies; track freq.value) {
                <mat-option [value]="freq.value">{{ freq.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

        <mat-checkbox formControlName="isRecurring" color="primary">
          Recurring expense
        </mat-checkbox>
        <p class="form-hint">Uncheck for one-time expenses (won't count towards monthly total)</p>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Start Date</mat-label>
            <input matInput type="date" formControlName="startDate">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>End Date</mat-label>
            <input matInput type="date" formControlName="endDate">
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Notes</mat-label>
          <textarea matInput formControlName="notes" rows="2" placeholder="Optional notes..."></textarea>
        </mat-form-field>
      </mat-card-content>

      <mat-card-actions align="end" class="inline-form__footer">
        <button mat-button type="button" (click)="closeExpenseForm()">Cancel</button>
        <button mat-flat-button color="primary" type="submit" [disabled]="expenseForm.invalid || isSubmitting()">
          @if (isSubmitting()) {
            <mat-spinner diameter="18"></mat-spinner>
          }
          {{ isSubmitting() ? 'Saving...' : (editingExpense() ? 'Update' : 'Add') }} Expense
        </button>
      </mat-card-actions>
    </form>
  </mat-card>
}

@if (isLoading()) {
  <div class="loading-container">
    <mat-spinner diameter="32"></mat-spinner>
    <p>Loading expenses...</p>
  </div>
} @else if (expenses().length === 0 && !showExpenseForm()) {
  <mat-card class="empty-state-card">
    <mat-card-content>
      <mat-icon class="empty-icon">payments</mat-icon>
      <h3>No expenses tracked yet</h3>
      <p>Add your recurring expenses like rent, utilities, subscriptions, and more.</p>
      <button mat-flat-button color="primary" (click)="openAddExpenseForm()">
        Add Your First Expense
      </button>
    </mat-card-content>
  </mat-card>
} @else if (expenses().length > 0) {
  <div class="expenses-list">
    @for (group of getExpensesByCategory(); track group.category?.id ?? 'uncategorised') {
      <div class="category-group">
        <div class="category-header" [style.border-left-color]="group.category?.color || '#95A5A6'">
          <div class="category-info">
            <span class="category-name">{{ group.category?.name || 'Uncategorised' }}</span>
            @if (!group.category?.isSystemDefault && group.category) {
              <button mat-icon-button class="edit-btn" (click)="openEditCategoryForm(group.category)" matTooltip="Edit category">
                <mat-icon>edit</mat-icon>
              </button>
            }
          </div>
          <span class="category-total">{{ getCategoryTotal(group.expenses) | currency:'AUD':'symbol-narrow':'1.0-0' }}/mo</span>
        </div>

        <mat-card>
          <mat-card-content class="expense-table-content">
            <table class="expense-table">
              <tbody>
                @for (expense of group.expenses; track expense.id) {
                  <tr [class.one-off]="!expense.isRecurring">
                    <td class="expense-name-cell">
                      <span class="expense-name">{{ expense.name }}</span>
                      @if (!expense.isRecurring) {
                        <span class="one-off-badge">One-off</span>
                      }
                    </td>
                    <td class="text-right mono">
                      {{ expense.amount | currency:'AUD':'symbol-narrow':'1.0-0' }}{{ formatFrequency(expense.frequency) }}
                    </td>
                    <td class="text-right mono monthly-amount">
                      @if (expense.isRecurring) {
                        {{ expense.monthlyAmount | currency:'AUD':'symbol-narrow':'1.0-0' }}/mo
                      }
                    </td>
                    <td class="actions-cell">
                      <button mat-icon-button (click)="openEditExpenseForm(expense)" matTooltip="Edit">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button mat-icon-button color="warn" (click)="deleteExpense(expense)" matTooltip="Delete">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </mat-card-content>
        </mat-card>
      </div>
    }

    <div class="total-bar">
      <span>Total Monthly Expenses</span>
      <span class="total-amount negative">{{ getTotalMonthly() | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
    </div>
  </div>
}
