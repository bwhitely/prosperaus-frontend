<div class="page-header">
  <div class="page-header__content">
    <h1>Dashboard</h1>
    <p>Your financial snapshot at a glance</p>
  </div>
</div>

@if (isLoading()) {
  <div class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Loading your financial data...</p>
  </div>
} @else if (error()) {
  <div class="error-container">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <p class="error-message">{{ error() }}</p>
    <button mat-flat-button color="primary" (click)="loadNetWorth()">Try Again</button>
  </div>
} @else {
  <div class="stat-cards">
    <mat-card class="stat-card stat-card--primary">
      <mat-card-content>
        <div class="stat-card__label">Net Worth</div>
        <div class="stat-card__value" [class.positive]="netWorth()!.netWorth >= 0" [class.negative]="netWorth()!.netWorth < 0">
          {{ netWorth()!.netWorth | currency:'AUD':'symbol-narrow':'1.0-0' }}
        </div>
        @if (!hasAssets()) {
          <div class="stat-card__hint">Add assets to get started</div>
        }
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-card__label">Total Assets</div>
        <div class="stat-card__value">
          {{ netWorth()!.totalAssets | currency:'AUD':'symbol-narrow':'1.0-0' }}
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-card__label">Total Liabilities</div>
        <div class="stat-card__value">
          {{ netWorth()!.totalLiabilities | currency:'AUD':'symbol-narrow':'1.0-0' }}
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Net Worth History Chart -->
  <mat-card class="chart-card mt-lg">
    <mat-card-header>
      <mat-card-title>Net Worth Over Time</mat-card-title>
      @if (hasHistoryData()) {
        <div class="history-summary">
          @if (historyData()!.summary.change >= 0) {
            <span class="change positive">+{{ historyData()!.summary.change | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
          } @else {
            <span class="change negative">{{ historyData()!.summary.change | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
          }
          <span class="change-percent">({{ historyData()!.summary.changePercent | number:'1.1-1' }}%)</span>
        </div>
      }
    </mat-card-header>
    <mat-card-content>
      @if (isHistoryLoading()) {
        <div class="chart-loading">
          <mat-spinner diameter="32"></mat-spinner>
          <p>Loading history...</p>
        </div>
      } @else if (hasHistoryData()) {
        <div class="chart-container">
          <canvas #netWorthChart></canvas>
        </div>
      } @else {
        <div class="chart-empty">
          <mat-icon>timeline</mat-icon>
          <p>No history data available yet.</p>
          <p class="text-muted">Net worth snapshots will be recorded over time to show your progress.</p>
        </div>
      }
    </mat-card-content>
  </mat-card>

  @if (hasAssets()) {
    <!-- Asset Breakdown -->
    <div class="dashboard-grid mt-lg">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Asset Breakdown</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="breakdown-list">
            <!-- Property -->
            @if (netWorth()!.assetBreakdown.propertyValue > 0) {
              <div class="breakdown-category" [class.expanded]="isExpanded('property')">
                <button class="breakdown-item breakdown-item--expandable" (click)="toggleCategory('property')">
                  <span class="breakdown-label">
                    <mat-icon class="expand-icon">{{ isExpanded('property') ? 'expand_less' : 'expand_more' }}</mat-icon>
                    Property
                  </span>
                  <span class="breakdown-value">{{ netWorth()!.assetBreakdown.propertyValue | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
                </button>
                @if (isExpanded('property')) {
                  <div class="breakdown-subitems">
                    @if (isCategoryLoading('property')) {
                      <div class="breakdown-subitem breakdown-subitem--loading">Loading...</div>
                    } @else if (properties().length === 0) {
                      <div class="breakdown-subitem breakdown-subitem--empty">No properties found</div>
                    } @else {
                      @for (prop of properties(); track prop.id) {
                        <div class="breakdown-subitem">
                          <span class="breakdown-sublabel">{{ prop.name }}</span>
                          <span class="breakdown-subvalue">{{ prop.currentValue | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
                        </div>
                      }
                    }
                  </div>
                }
              </div>
            }

            <!-- Superannuation -->
            @if (netWorth()!.assetBreakdown.superBalance > 0) {
              <div class="breakdown-category" [class.expanded]="isExpanded('super')">
                <button class="breakdown-item breakdown-item--expandable" (click)="toggleCategory('super')">
                  <span class="breakdown-label">
                    <mat-icon class="expand-icon">{{ isExpanded('super') ? 'expand_less' : 'expand_more' }}</mat-icon>
                    Superannuation
                  </span>
                  <span class="breakdown-value">{{ netWorth()!.assetBreakdown.superBalance | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
                </button>
                @if (isExpanded('super')) {
                  <div class="breakdown-subitems">
                    @if (isCategoryLoading('super')) {
                      <div class="breakdown-subitem breakdown-subitem--loading">Loading...</div>
                    } @else if (superAccounts().length === 0) {
                      <div class="breakdown-subitem breakdown-subitem--empty">No super accounts found</div>
                    } @else {
                      @for (account of superAccounts(); track account.id) {
                        <div class="breakdown-subitem">
                          <span class="breakdown-sublabel">{{ account.fundName }}</span>
                          <span class="breakdown-subvalue">{{ account.balance | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
                        </div>
                      }
                    }
                  </div>
                }
              </div>
            }

            <!-- Investments -->
            @if (netWorth()!.assetBreakdown.investmentValue > 0) {
              <div class="breakdown-category" [class.expanded]="isExpanded('investments')">
                <button class="breakdown-item breakdown-item--expandable" (click)="toggleCategory('investments')">
                  <span class="breakdown-label">
                    <mat-icon class="expand-icon">{{ isExpanded('investments') ? 'expand_less' : 'expand_more' }}</mat-icon>
                    Investments
                  </span>
                  <span class="breakdown-value">{{ netWorth()!.assetBreakdown.investmentValue | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
                </button>
                @if (isExpanded('investments')) {
                  <div class="breakdown-subitems">
                    @if (isCategoryLoading('investments')) {
                      <div class="breakdown-subitem breakdown-subitem--loading">Loading...</div>
                    } @else if (investments().length === 0) {
                      <div class="breakdown-subitem breakdown-subitem--empty">No investments found</div>
                    } @else {
                      @for (inv of investments(); track inv.id) {
                        <div class="breakdown-subitem">
                          <span class="breakdown-sublabel">
                            <span class="ticker-badge">{{ inv.ticker }}</span>
                            {{ inv.securityName || inv.ticker }}
                          </span>
                          <span class="breakdown-subvalue">{{ inv.currentValue | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
                        </div>
                      }
                    }
                  </div>
                }
              </div>
            }

            <!-- Cash -->
            @if (netWorth()!.assetBreakdown.cashBalance > 0) {
              <div class="breakdown-category" [class.expanded]="isExpanded('cash')">
                <button class="breakdown-item breakdown-item--expandable" (click)="toggleCategory('cash')">
                  <span class="breakdown-label">
                    <mat-icon class="expand-icon">{{ isExpanded('cash') ? 'expand_less' : 'expand_more' }}</mat-icon>
                    Cash
                  </span>
                  <span class="breakdown-value">{{ netWorth()!.assetBreakdown.cashBalance | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
                </button>
                @if (isExpanded('cash')) {
                  <div class="breakdown-subitems">
                    @if (isCategoryLoading('cash')) {
                      <div class="breakdown-subitem breakdown-subitem--loading">Loading...</div>
                    } @else if (cashAccounts().length === 0) {
                      <div class="breakdown-subitem breakdown-subitem--empty">No cash accounts found</div>
                    } @else {
                      @for (account of cashAccounts(); track account.id) {
                        <div class="breakdown-subitem">
                          <span class="breakdown-sublabel">{{ account.accountName }}</span>
                          <span class="breakdown-subvalue">{{ account.balance | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
                        </div>
                      }
                    }
                  </div>
                }
              </div>
            }
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-header>
          <mat-card-title>Asset Allocation</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="allocation-chart">
            @for (allocation of netWorth()!.assetAllocation; track allocation.category) {
              <div class="allocation-bar">
                <div class="allocation-bar__header">
                  <span class="allocation-bar__label">{{ allocation.category }}</span>
                  <span class="allocation-bar__percent">{{ allocation.percentage | number:'1.1-1' }}%</span>
                </div>
                <div class="allocation-bar__track">
                  <div class="allocation-bar__fill" [style.width.%]="allocation.percentage"></div>
                </div>
              </div>
            }
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Liability Breakdown -->
    @if (netWorth()!.totalLiabilities > 0) {
      <mat-card class="mt-lg">
        <mat-card-header>
          <mat-card-title>Liability Breakdown</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="breakdown-list breakdown-list--horizontal">
            @if (netWorth()!.liabilityBreakdown.mortgageBalance > 0) {
              <div class="breakdown-item">
                <span class="breakdown-label">Mortgages</span>
                <span class="breakdown-value breakdown-value--negative">{{ netWorth()!.liabilityBreakdown.mortgageBalance | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
              </div>
            }
            @if (netWorth()!.liabilityBreakdown.creditCardBalance > 0) {
              <div class="breakdown-item">
                <span class="breakdown-label">Credit Cards</span>
                <span class="breakdown-value breakdown-value--negative">{{ netWorth()!.liabilityBreakdown.creditCardBalance | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
              </div>
            }
            @if (netWorth()!.liabilityBreakdown.personalLoans > 0) {
              <div class="breakdown-item">
                <span class="breakdown-label">Personal Loans</span>
                <span class="breakdown-value breakdown-value--negative">{{ netWorth()!.liabilityBreakdown.personalLoans | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
              </div>
            }
            @if (netWorth()!.liabilityBreakdown.carLoans > 0) {
              <div class="breakdown-item">
                <span class="breakdown-label">Car Loans</span>
                <span class="breakdown-value breakdown-value--negative">{{ netWorth()!.liabilityBreakdown.carLoans | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
              </div>
            }
            @if (netWorth()!.liabilityBreakdown.hecsHelp > 0) {
              <div class="breakdown-item">
                <span class="breakdown-label">HECS/HELP</span>
                <span class="breakdown-value breakdown-value--negative">{{ netWorth()!.liabilityBreakdown.hecsHelp | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
              </div>
            }
            @if (netWorth()!.liabilityBreakdown.otherLiabilities > 0) {
              <div class="breakdown-item">
                <span class="breakdown-label">Other</span>
                <span class="breakdown-value breakdown-value--negative">{{ netWorth()!.liabilityBreakdown.otherLiabilities | currency:'AUD':'symbol-narrow':'1.0-0' }}</span>
              </div>
            }
          </div>
        </mat-card-content>
      </mat-card>
    }
  } @else {
    <!-- Getting Started Card -->
    <mat-card class="mt-lg">
      <mat-card-header>
        <mat-card-title>Get Started</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p class="text-secondary mb-md">
          Welcome to ProsperAus! Your platform for tracking wealth, optimising your tax position,
          and planning for financial independence using Australian tax rules.
        </p>

        <div class="d-flex flex-wrap gap-sm">
          <a mat-flat-button color="primary" routerLink="/profile">Complete Your Profile</a>
          <a mat-stroked-button routerLink="/equity-recycling">Try Equity Recycling Calculator</a>
        </div>
      </mat-card-content>
    </mat-card>
  }
}
